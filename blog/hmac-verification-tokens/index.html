<!doctype html><html lang=en-us><head><meta charset=UTF-8><title>Rotational Labs | HMAC Verification Tokens</title>
<base href=https://rotational.io/ target=_self><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Rotational Labs, Inc."><meta name=description content="A discussion of how to send secure tokens via email to validate an unauthenticated user that is trying to access some content on your system. This method prevents brute force attacks that guess tokens and attempts to minimize the surface area of a non-recipient accessing secure information using HMAC signatures."><meta name=keywords content="AI solutions for mid-market companies,AI-driven tools,Business automation solutions,AI-powered interfaces,Intelligent agents,Natural language processing (NLP),Computer vision AI,Streamline operations with AI,machine learning,Boost business performance with AI,AI for business growth,Tailored AI solutions,Trusted AI solutions,AI for operational efficiency,Secure AI tools,AI expertise for mid-market businesses,Endeavor"><link type=text/plain rel=author href=https://rotational.io/humans.txt><meta property="og:title" content="HMAC Verification Tokens"><meta property="og:description" content="A discussion of how to send secure tokens via email to validate an unauthenticated user that is trying to access some content on your system. This method prevents brute force attacks that guess tokens and attempts to minimize the surface area of a non-recipient accessing secure information using HMAC signatures."><meta property="og:image" content="https://rotational.io/img/blog/2024-11-06-hmac-verification-tokens/postman.jpg"><meta property="og:url" content="https://rotational.io/blog/hmac-verification-tokens/"><meta property="og:type" content="website"><meta name=twitter:title content="HMAC Verification Tokens"><meta name=twitter:card content="summary"><meta name=twitter:description content="A discussion of how to send secure tokens via email to validate an unauthenticated user that is trying to access some content on your system. This method prevents brute force attacks that guess tokens and attempts to minimize the surface area of a non-recipient accessing secure information using HMAC signatures."><meta name=twitter:image content="https://rotational.io/img/blog/2024-11-06-hmac-verification-tokens/postman.jpg"><link rel="shortcut icon" href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=alternate type=application/rss+xml href=https://rotational.io//index.xml title="Recent Rotations of the Rotational Labs Blog"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel=stylesheet><link rel=stylesheet href=https://rotational.io/output.css media=screen><script src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW" async defer></script><script type=module>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-2FKX6CWJHW');
</script><script async defer src="https://www.google.com/recaptcha/enterprise.js?render=6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk"></script><script src=https://kit.fontawesome.com/fea17a4e21.js crossorigin=anonymous></script></head><body><div class="relative bg-[#1D65A6]"><nav class="w-full max-w-7xl mx-auto px-4 sm:px-6 py-5" aria-label=Global><div class="relative max-w-7xl w-full flex flex-wrap lg:flex-nowrap items-center justify-between mx-auto"><a href=/><img src=/img/rototational-white-text-only_hu15583614935666962927.webp alt=Rotational class="h-6 w-auto">
</a><button data-collapse-toggle=navbar-dropdown type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200" aria-controls=navbar-dropdown aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="fa fa-bars text-xl text-white"></i></button><div class="hidden absolute z-[9999] lg:static top-16 w-[92%] md:w-[96%] lg:w-auto lg:block bg-white lg:bg-transparent text-[#192E5B] lg:text-[#F2F2F2] py-2 rounded-md" id=navbar-dropdown><ul class="flex flex-col lg:gap-2 xl:gap-4 md:flex-row font-semibold w-full md:justify-between"><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/about/>About</a></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><button id=dropdownNavbarLink data-dropdown-toggle=dropdownNavbar class="uppercase flex items-center justify-between gap-x-2 w-full px-3 rounded md:border-0 md:p-0 md:w-auto hover:text-black">
Services
<i class="fa fa-angle-down pt-1"></i></button><div id=dropdownNavbar class="z-10 hidden font-normal bg-[#192E5B] divide-y divide-[#192E5B] rounded-lg shadow w-44"><ul class="py-2 text-sm text-[#F2F2F2]" aria-labelledby=dropdownLargeButton><li><a href=/services/ai-assessments/ class="block px-3 py-2 hover:font-bold">AI Assessments</a></li><li><a href=/services/ai-product-development/ class="block px-3 py-2 hover:font-bold">AI Product Development</a></li><li><a href=/services/ai-ops-and-data-foundations/ class="block px-3 py-2 hover:font-bold">AI Ops & Data Foundations</a></li></ul></div></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/case-studies>Case Studies</a></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/blog/>Blog</a></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/learning/>Learning</a></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/endeavor/>Product</a></li><li class="py-2 uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-3 py-3.5 hover:text-black" href=/contact/>Contact</a></li></ul></div></div></nav></div><main><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class=mt-14><div class=blog-img><img src=/img/blog/2024-11-06-hmac-verification-tokens/postman_hu2177098599832057219.webp alt="HMAC Verification Tokens" class="mx-auto object-cover"></div><div class=mt-8><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center" data-blog-title="HMAC Verification Tokens"><b class=text-[#1D65A6]>HMAC </b>Verification Tokens</h3><div class="flex flex-wrap justify-center items-center my-4"><a href=/authors/benjamin-bengfort><img src=img/team/benjamin-bengfort.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg">
</a><span><a href=/authors/benjamin-bengfort>Benjamin Bengfort</a> | Wednesday, Nov 6, 2024 |&nbsp;
</span><span><a href=/tags/cryptography>Cryptography</a>,&nbsp;
</span><a href=/tags/security>Security</a>,&nbsp;
</span><a href=/tags/verification>Verification</a></span></div><article class="max-w-[800px] mx-auto prose"><p>In this post, we explore sending a secure message to a user that doesn&rsquo;t have an account on your system and therefore cannot be authenticated. We&rsquo;ll explore the use of HMAC verification tokens that you can email to a recipient as a single-use access code for a specific message or document.</p><p>Our example application is a document sharing tool. The tool gives read receipts and delivery notifications to the sender; e.g. for important letters or contracts that you need to know arrived at their destination. If both sender and receiver are already users, the application is fairly straightforward. The sender identifies the recipient, and the document is associated with that recipient&rsquo;s identifier. When the recipient logs in, they can access the document and the sender gets a read receipt.</p><p>But what happens when the sender wants to send a document to someone who is not yet a user? We can&rsquo;t send the document via email because we will not be able to establish a read receipt. Instead, we send the user a link to the document via email, allowing us to track reads. But this adds another complication; how do we guarantee that only the recipient is allowed to access that particular document?</p><p>Although we can&rsquo;t guarantee that the recipient is the one accessing the document; we can take some steps to reduce the likelihood that a bad actor is accessing the document using HMAC verification tokens as described in the architecture below:</p><p><a href=/img/blog/2024-11-06-hmac-verification-tokens/verification.png><img alt="HMAC Verification Token Architecture" src=/img/blog/2024-11-06-hmac-verification-tokens/verification.png></a></p><p>A basic outline is as follows:</p><ol><li>Store the document in the database and get a unique ID for it.</li><li>Create an expiration date sometime in the future and a random nonce.</li><li>Create a byte array that is the concatenation of the ID, expiration, and nonce.</li><li>Generate a secret key and create an HMAC signature on the concatenation with it.</li><li>Store the signature and concatenation in your database, send the secret key and message ID to the recipient via email.</li><li>When the recipient is ready to access the document, they come to your site and present the secret key and message id.</li><li>Look up the concatenation and signature associated with the ID, then verify that the document has not expired adn that the secret key creates the same HMAC signature &ndash; if so, you can allow access to the recipient.</li></ol><p>A discussion of how and why this works is below, along with some implementation details in Go.</p><h2 id=hmac-signatures>HMAC Signatures</h2><p>An HMAC (hash-based authentication code) signature is a hash of some data generated by a cryptographic function that requires the exact original data and a secret key. It is used in TLS and other cryptographic mechanisms to guarantee that a message has not changed by a <a href=https://en.wikipedia.org/wiki/Man-in-the-middle_attack>man-in-the-middle</a> when sent between two parties.</p><p>Let&rsquo;s say that Alice generates a message, <code>m</code> and sends it to Bob; how does Bob know that <code>m</code> is the original message that Alice sent and that a bad actor didn&rsquo;t modify the message to <code>m'</code> while it was on route? If Alice and Bob can share a secret key before Alice sends the message, then Alice can generate an HMAC signature, <code>s</code> of message <code>m</code> with that secret key and send it with the message. Bob then generates another HMAC signature <code>t</code> on the message he receives with his secret. If <code>s==t</code> then <code>m</code> must be the original message and has not been modified.</p><p>If an attacker modifies even one bit and creates a message <code>m'</code> then <code>t</code> cannot match <code>s</code>. Even if an attacker attempts to modify the message <em>and</em> the signature sent with the message, it will not work because the attacker will not have the secret key.</p><h2 id=discussion>Discussion</h2><p>What about simply using a random string and sending that to the user? In this case, there is the possibility that an attacker might guess the string and get access to a document they shouldn&rsquo;t have. The more documents in your system, the more likely a guess will be associated with a document. This can be prevented with longer random strings, etc. But we can do better than relying on randomness for security.</p><p>It might also seem a bit odd that we&rsquo;re sending the secret key to the recipient.The HMAC method described above requires the key to be shared ahead of time and the signature sent along with the message. However, by storing the signature and sending the key, we&rsquo;re actually reducing the surface area of the attack in the admittedly rare case where the attacker might gain access only to our token generating database. If so, the attacker has enough information (the secret + the concatenated data) to generate the signature to access the document.</p><p>Finally, rate-limiting and expiration timestamps are also important to prevent access. Rate limiting reduces the number of guesses from a specific IP address and helps prevent brute force attacks. Expiration timestamps essentially limit the number of possible documents that can be accessed at any given time. Finally, if the document expires, a valid token can be used to generate a new token and sent to the original email, preventing unauthorized access in a two step process.</p><h2 id=implementation>Implementation</h2><p>Some example code is below to clarify the components to the reader. First create a message that needs to be sent to the user:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Message</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>          <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expiration</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nonce</span>       []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewMessage</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>, <span style=color:#a6e22e>expiration</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Message</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Message</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Expiration</span>: <span style=color:#a6e22e>expiration</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nonce</span>: make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>64</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make sure to use crypto/rand and to deal with errors!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>nonce</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>message</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Message</span>) <span style=color:#a6e22e>MarshalBinary</span>() ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use your favorite data serialization method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Message</span>) <span style=color:#a6e22e>UnmarshalBinary</span>([]<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use your favorite data serialization method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The message keeps the <code>nonce</code> internal to ensure that it is randomly generated. The random nonce helps ensure that for the same ID and expiration a different HMAC verification token is generated and further increases the cryptographic complexity. However, make sure that your database storage mechanism also stores the nonce. The way I like to do this is to store the message binary as a BLOB in the database then use <code>UnmarshalBinary</code> to recreate the data without exporting the <code>nonce</code>.</p><p>To create the HMAC signature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SignedMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Message</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signature</span> []<span style=color:#66d9ef>byte</span> <span style=color:#75715e>// The HMAC signature computed from the Token data (read-only)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Token</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Message</span>) <span style=color:#a6e22e>Sign</span>() (<span style=color:#a6e22e>token</span> <span style=color:#a6e22e>Token</span>, <span style=color:#a6e22e>signature</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SignedMessage</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a random secret key for signing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>secret</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>64</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>secret</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;no crypto random generator available: %w&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Marshal the token for signing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>MarshalBinary</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create HMAC signature for the token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mac</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hmac</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>sha256</span>.<span style=color:#a6e22e>New</span>, <span style=color:#a6e22e>secret</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>mac</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Get the HMAC signature and append it to the verification data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// NOTE: this must happen after HMAC signing!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>signature</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SignedMessage</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Token</span>:     <span style=color:#f92672>*</span><span style=color:#a6e22e>t</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>signature</span>: <span style=color:#a6e22e>mac</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create the verification token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>token</span> = make(<span style=color:#a6e22e>Token</span>, <span style=color:#ae81ff>80</span>)
</span></span><span style=display:flex><span>	copy(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>16</span>], <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SunriseID</span>[:])
</span></span><span style=display:flex><span>	copy(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>16</span>:], <span style=color:#a6e22e>secret</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>signature</span>, <span style=color:#66d9ef>nil</span>
</span></span></code></pre></div><p>We create two new types: a <code>SignedMessage</code> that includes the <code>signature</code> along with the original message data and a <code>Token</code>, which is just an array of bytes &ndash; the UUID concatenated with the secret key. I like to send the token in the email as a base64 encoded string as shown below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#a6e22e>Token</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>EncodeToString</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The message is marshalled into a binary form, then a rand secret key is generated and used to create the HMAC signature along with a SHA256 hash. This signature is stored alongside the message and the ID and the secret are concatened together to send to the recipient.</p><p>You should store the <code>SignedMessage</code> in your database for retrieval later. I use the <code>Scanner</code> and <code>Valuer</code> interface for this, storing a binary representation of the signed message as a BLOB. This allows me to include the <code>nonce</code> and the <code>signature</code> in the binary data without worrying about exporting those fields. Just remember, you need to index on the <code>ID</code> field, so store that separately!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SignedMessage</span>) <span style=color:#a6e22e>Scan</span>(<span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>.([]<span style=color:#66d9ef>byte</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrUnexpectedType</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>UnmarshalBinary</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SignedMessage</span>) <span style=color:#a6e22e>Value</span>() (<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>MarshalBinary</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now send the <code>Token</code> to the user and store the <code>SignedMessage</code> in your database. When the user presents you with the <code>Token</code> look up the <code>SignedMessage</code> in the database using the first 16 bytes which is the UUID of the message. The last 64 bytes is the secret key which can be verified as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SignedMessage</span>) <span style=color:#a6e22e>Verify</span>(<span style=color:#a6e22e>token</span> <span style=color:#a6e22e>Token</span>) (<span style=color:#a6e22e>secure</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>token</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>80</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>ErrSize</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Compute the hash of the current token for verification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Message</span>.<span style=color:#a6e22e>MarshalBinary</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Generate the HMAC signature of the current token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mac</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hmac</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>sha256</span>.<span style=color:#a6e22e>New</span>, <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>16</span>:])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mac</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>signature</span>, <span style=color:#a6e22e>mac</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#66d9ef>nil</span>)), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>HMAC verification tokens are an excellent way to perform a one-time or one-access authentication for a user that is not a member of your system. We use them for inviting users to join a group, sending external messages via <a href=https://whisper.rotational.dev/>Whisper</a>, confirming email addresses or phone numbers, and even for password resets!</p><div class="border-t my-12"></div><p>AI Image Generated with Leonardo.ai</p></article></div></div><div class="bg-[#E8EFF6] max-w-[800px] mx-auto mt-9 p-8 rounded-lg"><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center mb-3"><span class="text-[#1D65A6] font-bold">About </span>This Post</h3><p class="text-base mx-auto px-2 text-center lg:text-base">A discussion of how to send secure tokens via email to validate an unauthenticated user that is trying to access some content on your system. This method prevents brute force attacks that guess tokens and attempts to minimize the surface area of a non-recipient accessing secure information using HMAC signatures.</p><div class="flex flex-col md:flex-row text-center mx-auto border-t pt-6 mt-6 align-center justify-between gap-10"><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Written by:</h2><div class="flex items-center"><a href=/authors/benjamin-bengfort><img src=img/team/benjamin-bengfort.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg">
</a><span class="flex flex-wrap"><a href=/authors/benjamin-bengfort class="lg:w-[20ch] mx-2">Benjamin Bengfort</a></span></div></div><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Share this post:</h2><ul class="flex items-center justify-center gap-6 mt-4"><li><a onclick=shareByEmail() class=cursor-pointer><img src=img/email.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnTwitterWithTitle() class=cursor-pointer><img src=img/twitter.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnLinkedIn() class=cursor-pointer><img src=img/linkedin.png alt class="rounded-lg bg-white p-3"></a></li></ul></div></div></div><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class="flex justify-between mt-12 sm:mt-24 items-center"><div class="flex items-center"><h2 class="font-bold text-2xl sm:text-4xl flex"><span class=text-[#1D65A6]>Recommended</span>
&nbsp;Rotations</h2></div><div><a href=/blog class="flex text-base sm:text-lg items-center font-bold text-[#1D65A6]"><span>View all</span>
<img src=img/arr-right.png alt class="h-4 ml-2"></a></div></div><div><ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:mt-16"><li class="mt-6 bg-[#ECF6FF] rounded-xl"><div class="flex flex-col h-full"><a href=https://rotational.io/blog/rotational-joins-eu-us-data-privacy-framework-to-strengthen-privacy-commitment/><img loading=lazy src=/img/blog/EU-US-DPF_hu7011446156396377057.webp alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="px-4 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/privacy>Privacy</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/security>Security</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/ai>AI</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/trust>Trust</a></li></ul><div class="flex flex-col mt-4 h-full"><h3 class="text-xl font-extrabold sm:h-36"><a href=https://rotational.io/blog/rotational-joins-eu-us-data-privacy-framework-to-strengthen-privacy-commitment/ class=block>Rotational Joins EU-US Data Privacy Framework to Strengthen Privacy Commitment</a></h3><div class=mb-4><p class="my-4 sm:mt-auto">Rotational has joined the US-EU Data Privacy Framework, reinforcing its commitment to privacy in an era of growing data-driven innovation and generative AI.</p></div></div></div><div class="flex justify-between mt-auto items-center border-t px-4 py-3 h-16"><div class="flex items-center"><img loading=lazy src=/img/team/edwin-schmierer_hu5621933698583174314.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/edwin-schmierer>Edwin Schmierer</a></li></ul></div><div class=font-extralight>Dec 5, 2024</div></div></div></li><li class="mt-6 bg-[#ECF6FF] rounded-xl"><div class="flex flex-col h-full"><a href=https://rotational.io/blog/data-access-controls-for-generative-ai/><img loading=lazy src=/img/blog/2024-08-26-data-access-controls-for-generative-ai/data-vault_hu6264025734099521437.webp alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="px-4 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/security>Security</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/ai>AI</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/data-access>Data Access</a></li></ul><div class="flex flex-col mt-4 h-full"><h3 class="text-xl font-extrabold sm:h-36"><a href=https://rotational.io/blog/data-access-controls-for-generative-ai/ class=block>Data Access Controls for Generative AI</a></h3><div class=mb-4><p class="my-4 sm:mt-auto">Anyone who has worked on a POSIX system is used to fine-grained data access rights for files and directories. In a world of generative AI, do we need a new permissions model for files used to train LLMs and serve live inferences?</p></div></div></div><div class="flex justify-between mt-auto items-center border-t px-4 py-3 h-16"><div class="flex items-center"><img loading=lazy src=/img/team/benjamin-bengfort_hu17822499508975549251.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/benjamin-bengfort>Benjamin Bengfort</a></li></ul></div><div class=font-extralight>Aug 26, 2024</div></div></div></li><li class="mt-6 bg-[#ECF6FF] rounded-xl"><div class="flex flex-col h-full"><a href=https://rotational.io/blog/compression-vs-cryptography/><img loading=lazy src=/img/blog/espresso-press_hu13724950794995798785.webp alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="px-4 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/compression>Compression</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/cryptography>Cryptography</a>,&nbsp;</li><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/benchmarks>Benchmarks</a></li></ul><div class="flex flex-col mt-4 h-full"><h3 class="text-xl font-extrabold sm:h-36"><a href=https://rotational.io/blog/compression-vs-cryptography/ class=block>Compression vs Cryptography: What Comes First?</a></h3><div class=mb-4><p class="my-4 sm:mt-auto">Data encryption and compression are heavyweight algorithms that must be used with care in performance intensive applications; but when applying both mechanics to the same data, which should come first?</p></div></div></div><div class="flex justify-between mt-auto items-center border-t px-4 py-3 h-16"><div class="flex items-center"><img loading=lazy src=/img/team/benjamin-bengfort_hu17822499508975549251.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/benjamin-bengfort>Benjamin Bengfort</a></li></ul></div><div class=font-extralight>Oct 31, 2023</div></div></div></li></ul></div></div></div><div class="bg-[#1D65A6] max-w-[800px] mx-auto mt-20 py-14 px-12 md:px-16 text-white md:rounded-lg"><form action=blog method=post id=newsletterForm><h6 class="font-bold text-center">Enter Your Email To Subscribe</h6><label for=email class=hidden>Email</label>
<input type=text name=email id=email required placeholder class="w-full px-4 py-2.5 rounded-lg mt-6 text-black" style=color:#000><div class="flex mt-6 items-start gap-x-2"><input type=checkbox id=checkbox required class="mt-1 w-4 h-4 block border-0">
<label for=checkbox><span>I want to receive the monthly newsletter and other updates from Rotational. You agree to our Privacy Policy. You may unsubscribe at any time.*</span></label></div><div class="bg-teal-100 border-t-4 border-teal-500 mt-10 rounded-b text-teal-900 px-4 py-3 shadow-md hidden" id=newsletter-alert role=alert><div class=flex><div><p class=text-sm>Thank you for your interest!</p></div></div></div><div class="flex justify-center"><button type=submit class="bg-[#192E5B] px-14 py-4 mt-10 rounded-lg text-sm text-white uppercase md:text-base">
Submit</button></div></form></div></main><footer class="relative mt-40 md:mt-56 bg-[#192E5B]"><div class="relative w-full pt-36 md:pt-16 lg:pt-24 2xl:pt-20 font-extralight text-white"><div class="-mt-52 w-full mx-auto max-w-screen-xl px-4"><section class="bg-[#72A2C0] w-full p-6 md:py-20 md:px-16"><h2 class="my-4 text-2xl sm:text-3xl md:text-5xl text-white font-extrabold">LET'S ENVISION & BUILD THE FUTURE TOGETHER.</h2><div class=py-6><a href=/contact class="p-3 md:p-4 md:px-6 bg-[#2F4858] font-bold md:text-lg text-white text-center hover:bg-[#2F4858]/80">CONTACT US</a></div></section></div><div class="max-w-7xl mx-auto px-6"><div class="mt-12 flex flex-col md:flex-row lg:justify-between gap-x-8"><div class="my-4 max-w-xs"><h5 class="mb-3 font-extrabold">OUR PRESENCE</h5><p>We share because we care, about topics, tools, and technologies that we believe impact the AI economy.</p><div class=py-4><ul class="flex justify-between items-center gap-x-8"><li><a href=https://twitter.com/rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-x-twitter"></i><p class=sr-only>Twitter</p></a></li><li><a href=https://www.linkedin.com/company/rotational target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-linkedin"></i><p class=sr-only>LinkedIn</p></a></li><li><a href=https://github.com/rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-github"></i><p class=sr-only>GitHub</p></a></li><li><a href=https://www.youtube.com/@rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-youtube"></i><p class=sr-only>YouTube</p></a></li><li><a href=https://www.twitch.tv/rotationallabs target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-twitch"></i><p class=sr-only>Twitch</p></a></li></ul></div></div><div class=my-4><h5 class="mb-3 font-extrabold">COMPANY</h5><ul><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/about>About Us</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/case-studies>Case Studies</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/endeavor>Endeavor</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/blog>Blog</a></li></ul></div><div class=my-4><h5 class="mb-3 font-extrabold">COMMUNITY</h5><ul><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/learning>Learning</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/opensource>Open Source</a></li></ul></div><div class=my-4><h5 class="mb-3 font-extrabold">CONTACT US</h5><ul><li class="flex items-baseline lg:items-center gap-x-2"><i class="fa-solid fa-map-marker-alt text-[#757575]"></i>
St. Paul, MN & Washington, DC</li><li class="flex items-baseline lg:items-center gap-x-2"><i class="fa-solid fa-envelope text-[#757575]"></i>
info@rotational.io</li></ul><div class=py-8><a href=/contact class="p-3 bg-[#ECF6FF] font-bold text-black text-center hover:bg-[#ECF6FF]/80">CONTACT US</a></div></div></div><div class="sm:flex justify-between py-6 border-t mt-4"><p>Copyright © Rotational Labs, Inc. 2021–2024 · All Rights Reserved</p><div><ul class="sm:mt-0 mt-4 flex gap-x-8"><li><a href=/privacy/>Privacy Policy</a></li><li><a href=/terms/>Terms of Use</a></li></ul></div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/24168101.js></script><script src=https://rotational.io/js/blogSingle.js></script></body></html>