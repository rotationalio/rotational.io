<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Rotational Labs | Achieving Total Ordering With CRDTs</title><base href=https://rotational.io/ target=_self><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Rotational Labs, Inc."><meta name=description content="Conflict-free replicated data types are starting to take off in popularity, especially in terms of collaborative applications. In this post we will explore how these data structures can be used to achieve a total ordering of events across many peers."><meta name=keywords content="AI solutions for mid-market companies,AI-driven tools,Business automation solutions,AI-powered interfaces,Intelligent agents,Natural language processing (NLP),Computer vision AI,Streamline operations with AI,machine learning,Boost business performance with AI,AI for business growth,Tailored AI solutions,Trusted AI solutions,AI for operational efficiency,Secure AI tools,AI expertise for mid-market businesses,Endeavor"><link type=text/plain rel=author href=https://rotational.io/humans.txt><meta property="og:title" content="Achieving Total Ordering With CRDTs"><meta property="og:description" content="Conflict-free replicated data types are starting to take off in popularity, especially in terms of collaborative applications. In this post we will explore how these data structures can be used to achieve a total ordering of events across many peers."><meta property="og:image" content="https://rotational.io/img/blog/hourglass.jpg"><meta property="og:url" content="https://rotational.io/blog/achieving-total-ordering-with-crdts/"><meta property="og:type" content="website"><meta name=twitter:title content="Achieving Total Ordering With CRDTs"><meta name=twitter:card content="summary"><meta name=twitter:description content="Conflict-free replicated data types are starting to take off in popularity, especially in terms of collaborative applications. In this post we will explore how these data structures can be used to achieve a total ordering of events across many peers."><meta name=twitter:image content="https://rotational.io/img/blog/hourglass.jpg"><link rel="shortcut icon" href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=alternate type=application/rss+xml href=https://rotational.io//index.xml title="Recent Rotations of the Rotational Labs Blog"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.css><link rel=stylesheet href=https://unpkg.com/@highlightjs/cdn-assets/styles/default.min.css><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel=stylesheet><link rel=stylesheet href=https://rotational.io/output.css media=screen><script async src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2FKX6CWJHW")</script><script src="https://www.google.com/recaptcha/enterprise.js?render=6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk"></script>
<script>grecaptcha.enterprise.ready(function(){grecaptcha.enterprise.execute("6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk",{action:"homepage"}).then(function(){})})</script><script src=https://unpkg.com/lunr/lunr.js></script></head><body><div class="relative bg-[#1D65A6]"><nav class="w-full max-w-7xl mx-auto px-4 sm:px-6 py-5" aria-label=Global><div class="relative max-w-7xl w-full flex flex-wrap lg:flex-nowrap items-center justify-between mx-auto p-4"><a href=/><img src=img/rototational-white-text-only.png alt=Rotational class="h-6 w-auto"></a>
<button data-collapse-toggle=navbar-dropdown type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200" aria-controls=navbar-dropdown aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="fa fa-bars text-xl text-white"></i></button><div class="hidden absolute z-[9999] lg:static top-16 w-[92%] md:w-[96%] lg:w-auto lg:block bg-white lg:bg-transparent text-[#192E5B] lg:text-[#F2F2F2] py-4 rounded-md" id=navbar-dropdown><ul class="flex flex-col gap-4 md:flex-row font-semibold w-full md:justify-between"><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-4 py-3.5 hover:text-black" href=/about/>About</a></li><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><button id=dropdownNavbarLink data-dropdown-toggle=dropdownNavbar class="uppercase flex items-center justify-between gap-x-2 w-full py-2 px-3 rounded md:border-0 md:p-0 md:w-auto hover:text-black">
Services
<i class="fa fa-angle-down pt-1"></i></button><div id=dropdownNavbar class="z-10 hidden font-normal bg-[#192E5B] divide-y divide-[#192E5B] rounded-lg shadow w-44"><ul class="py-2 text-sm text-[#F2F2F2]" aria-labelledby=dropdownLargeButton><li><a href=/services/ai-assessments/ class="block px-4 py-2 hover:font-bold">AI Assessments</a></li><li><a href=/services/ai-product-development/ class="block px-4 py-2 hover:font-bold">AI Product Development</a></li><li><a href=/services/ai-ops-and-data-foundations/ class="block px-4 py-2 hover:font-bold">AI Ops & Data Foundations</a></li></ul></div></li><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-4 py-3.5 hover:text-black" href=/case-studies>Case Studies</a></li><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-4 py-3.5 hover:text-black" href=/blog/>Blog</a></li><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-4 py-3.5 hover:text-black" href=/resources>Learning</a></li><li class="uppercase text-sm lg:text-[15px] xl:text-[17px]"><a class="px-4 py-3.5 hover:text-black" href=/products/>Product</a></li></ul></div></div></nav></div><main><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class=mt-14><div class=blog-img><img src=https://rotational.io/img/blog/hourglass.jpg alt="Achieving Total Ordering With CRDTs" class="mx-auto object-cover"></div><div class=mt-8><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center" data-blog-title="Achieving Total Ordering With CRDTs"><b class=text-[#1D65A6]>Achieving</b>
Total Ordering With CRDTs</h3><div class="flex flex-wrap justify-center items-center my-4"><a href=/authors/patrick-deziel><img src=img/team/patrick-deziel.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg"></a>
<span><a href=/authors/patrick-deziel>Patrick Deziel</a> | Wednesday, May 4, 2022 |&nbsp;</span>
<span><a href=/tags/distributed-systems>Distributed Systems</a></span></div><article class="max-w-[800px] mx-auto prose"><p>Conflict-free replicated data types (or &ldquo;CRDTs&rdquo;) are inspiring the creation of more collaborative applications and improving the experience of users of distributed systems. In this post, we will explore how these data structures can be used to achieve a consistent, total ordering of events across many peers.</p><h2 id=what-is-a-crdt>What Is a CRDT?</h2><p>Distributed systems require coordination between nodes. One effective method is to use locks to prevent concurrent access to shared resources, but this limits collaboration between users. A more advanced method is to use consensus algorithms such as Paxos or Raft; these however are difficult to implement <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> and network-intensive<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> due to the amount of communication required between nodes, as each write decision must be agreed on before it can be committed/executed.</p><p>CRDTs achieve consensus at the <em>data</em> layer. They consist of some state which can be modified and a <code>merge</code> function which merges two states together to produce a completely deterministic value. This is a critical differentiator from other consensus mechanisms. Instead of trying to avoid conflict, we embrace that conflict is going to happen and have some way of &ldquo;auto-resolving&rdquo; concurrent writes to a value that all peers will consistently agree on. This comes at the cost of sacrificing some user intent, but improves the extent to which peers can operate concurrently.</p><p>CRDTs can also be thought of as data structures designed specifically for replication. The <code>merge</code> function is idempotent, associative, and commutative. This ensures that merges can be done in any order and therefore peers can operate mostly asynchronously, only communicating with each other when it&rsquo;s necessary to exchange data.</p><h2 id=okay-but-what-does-that-look-like-in-code>Okay, But What Does that Look Like in Code?</h2><p>Programming languages such as Python gives us some fundamental data structures for modeling CRDTs. Python&rsquo;s <code>set</code> is the canonical example of a set-based CRDT. It implements an unordered set of unique elements and a <code>union</code> function which consistently merges two sets together. We can put a simple class wrapper around this and call it a <code>GSet</code> or <code>Grow-Only Set</code> CRDT<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GSet</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    GSet implements a grow-only set CRDT. Items can be added to the set but can&#39;t be
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    removed.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>items <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(self, item):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Adds an item to the set.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>items<span style=color:#f92672>.</span>add(item)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>merge</span>(self, other):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Merges another GSet with this one.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(other, GSet):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Incompatible CRDT for merge(), expected GSet&#34;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>items <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>items<span style=color:#f92672>.</span>union(other<span style=color:#f92672>.</span>items)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Returns the current items in the set.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>items
</span></span></code></pre></div><p>Note that there are inherent limitations with this data structure. There is currently no way to remove an item from the set or realize an ordering of the items. To accomplish this we have to inject some metadata into the items that we are actually inserting into the set, which we will see shortly.</p><p>Python&rsquo;s <code>dict</code> also shares some properties with the <code>set</code> so it allows us to implement a shared counter across an arbitrary number of peers, or a <code>Grow-Only Counter</code> or <code>GCounter</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GCounter</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    GCounter implements a grow-only counter CRDT. It must be instantiated with a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    network-unique ID.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, id<span style=color:#f92672>=</span>uuid<span style=color:#f92672>.</span>uuid4()):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> id
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>counts <span style=color:#f92672>=</span> {id: <span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(self, value):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Adds a non-negative value to the counter.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Only non-negative values are allowed for add()&#34;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>counts[self<span style=color:#f92672>.</span>id] <span style=color:#f92672>+=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>merge</span>(self, other):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Merges another GCounter with this one.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(other, GCounter):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Incompatible CRDT for merge(), expected GCounter&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> id, count <span style=color:#f92672>in</span> other<span style=color:#f92672>.</span>counts<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>counts[id] <span style=color:#f92672>=</span> max(self<span style=color:#f92672>.</span>counts<span style=color:#f92672>.</span>get(id, <span style=color:#ae81ff>0</span>), count)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Returns the current value of the counter.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sum(self<span style=color:#f92672>.</span>counts<span style=color:#f92672>.</span>values())
</span></span></code></pre></div><p>Note that this data structure assumes that separate instances will have distinct IDs. On a single system we can use UUIDs to achieve this, but on distributed systems this issue of peer discovery and distinctness is a really tough problem.</p><p>An important property of CRDTs is that they can be composed together create more complex CRDTs. For example, we can use two <code>GSet</code>s to implement a <code>TwoPhaseSet</code> which has one set for &ldquo;added&rdquo; items and one set for &ldquo;removed&rdquo; items, solving the problem of not being able to remove items from the <code>GSet</code>. This makes the <code>GSet</code> and <code>GCounter</code> two simple yet powerful abstractions for implementing distributed applications.</p><h2 id=totally-ordered-events>Totally Ordered Events</h2><p>For a variety of distributed applications (pub/sub, collaborative editing, log integration, etc.) it&rsquo;s helpful to have a total ordering of events across the entire system. We can use a <code>Sequence</code> CRDT<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> to implement this ordering.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sequence</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Sequence is a CRDT that represents an ordered set of objects.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, id<span style=color:#f92672>=</span>uuid<span style=color:#f92672>.</span>uuid4()):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> id
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>operations <span style=color:#f92672>=</span> GSet()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>clock <span style=color:#f92672>=</span> GCounter(self<span style=color:#f92672>.</span>id)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sequence <span style=color:#f92672>=</span> []
</span></span></code></pre></div><h3 id=the-logical-clock>The Logical Clock</h3><p>Distributed systems in the physical world consist of nodes that are separated by both distance and time. Communication between nodes is not instantaneous due to distance and incurs some latency. In addition, nodes are running on independent machines which suffer from clock drift. In the absence of expensive, <a href=https://static.googleusercontent.com/media/research.google.com/en//archive/spanner-osdi2012.pdf>specialized hardware</a>, relying on physical time to order events will impact consistency. Therefore, time in a distributed system is often reframed as a <a href=https://en.wikipedia.org/wiki/Happened-before>happened-before</a> relationship using logical timestamps.</p><p>A logical clock can be implemented in a distributed context using a <code>GCounter</code> CRDT. Every time a node does a write (e.g., a PUT to a database value), we can simply increment the clock to the next integer value. When we merge the CRDT with another node, the independently running clocks become synced similarly to how physical clocks are synced. If two events happen at the same logical time then we need some mechanism to decide which event happened first. For example, we can order by node name as a tiebreaker. This is an arbitrary ordering but results in a consistent state across nodes.</p><pre tabindex=0><code>alice@1 -&gt; bob@2 -&gt; alice@3 -&gt; bob@3
</code></pre><h3 id=the-event-set>The Event Set</h3><p>To maintain a consistent set of events across a number of nodes, we can use a <code>GSet</code>. This is an append-only data structure which is updated when a node emits an event. When creating an event to store in the <code>GSet</code>, it gets hashed based on the node name and the current value of the logical clock to ensure that all events are unique. For example, we can imagine collaborative editor which supports an &ldquo;insert&rdquo; operation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>insert</span>(self, position, item):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Executes an &#34;insert&#34; operation and adds it to the log.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Tick the clock</span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>clock<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create a unique operation ID</span>
</span></span><span style=display:flex><span>    target <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>object_at_position(position)<span style=color:#f92672>.</span>operation
</span></span><span style=display:flex><span>    owner <span style=color:#f92672>=</span> OpId(self<span style=color:#f92672>.</span>id, self<span style=color:#f92672>.</span>clock<span style=color:#f92672>.</span>get())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add the insert operation to the log and update the sequence</span>
</span></span><span style=display:flex><span>    op <span style=color:#f92672>=</span> Operation(
</span></span><span style=display:flex><span>        owner<span style=color:#f92672>=</span>owner,
</span></span><span style=display:flex><span>        action<span style=color:#f92672>=</span>OperationType<span style=color:#f92672>.</span>INSERT_BEFORE,
</span></span><span style=display:flex><span>        target<span style=color:#f92672>=</span>target,
</span></span><span style=display:flex><span>        payload<span style=color:#f92672>=</span>item
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>operations<span style=color:#f92672>.</span>add(op)
</span></span><span style=display:flex><span>    op<span style=color:#f92672>.</span>do(self<span style=color:#f92672>.</span>sequence)
</span></span></code></pre></div><h3 id=replicating-the-events>Replicating the Events</h3><p>To achieve eventual consistency across a number of nodes we need to be able to replicate the event log to other nodes. At the CRDT level our <code>Sequence</code> needs to be able to merge with an arbitrary <code>Sequence</code> that we have received from another node. Merging this composite CRDT is equivalent to merging the two &ldquo;child&rdquo; CRDTs: the event set and the logical clock. If we are managing a local state that&rsquo;s not CRDT-based (e.g., an ordered list of objects exposed to the user), we need to &ldquo;patch&rdquo; the state by applying the newly discovered events.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>merge</span>(self, other):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Merge another Sequence with this one.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(other, Sequence):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Incompatible CRDT for merge(), expected Sequence&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Sync the local clock with the remote clock</span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>clock <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>clock<span style=color:#f92672>.</span>merge(other<span style=color:#f92672>.</span>clock)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get the new operations to be applied</span>
</span></span><span style=display:flex><span>    patch_ops <span style=color:#f92672>=</span> other<span style=color:#f92672>.</span>operations<span style=color:#f92672>.</span>get()<span style=color:#f92672>.</span>difference(self<span style=color:#f92672>.</span>operations<span style=color:#f92672>.</span>get())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get a sorted view of the patches to apply</span>
</span></span><span style=display:flex><span>    patch_log <span style=color:#f92672>=</span> sorted(patch_ops, key<span style=color:#f92672>=</span>cmp_to_key(self<span style=color:#f92672>.</span>compare_operations))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Patch the sequence using the new operations</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> op <span style=color:#f92672>in</span> patch_log:
</span></span><span style=display:flex><span>        op<span style=color:#f92672>.</span>do(self<span style=color:#f92672>.</span>sequence)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Merge the two operation logs</span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>operations <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>operations<span style=color:#f92672>.</span>merge(other<span style=color:#f92672>.</span>operations)
</span></span></code></pre></div><h2 id=extending-the-implementation>Extending the Implementation</h2><p>Using the <code>Sequence</code> CRDT it&rsquo;s possible to implement a distributed log which maintains a total ordering of events across an arbitrary number of nodes. We have used this abstraction to create a prototype for a collaborative Jupyter-like notebook <a href=https://github.com/rotationalio/eirene>editor</a>. In this context, the events refer to inserts and removes of notebook cells and characters within those cells. When two peers want to sync, they send their versions of the notebook to each other. Since the CRDT merge results in a consistent state for both peers, they are both able to render a consistent state to the user.</p><p><img src=/img/blog/2022-05-04-achieving-total-ordering-with-crdts/alicebob.png alt="Merging Sequences"></p><p>Feel free to check out our open source demo <a href=https://github.com/rotationalio/eirene>client</a> and our <a href=https://www.slideshare.net/RebeccaBilbro/conflictfree-replicated-data-types-pycon-2022>talk</a> at PyCon US 2022!</p><hr><p>Photo by <a href="https://unsplash.com/@aronvisuals?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Aron Visuals</a> on <a href="https://unsplash.com/s/photos/time?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p><h4 id=further-reading>Further Reading</h4><ul><li><a href=https://github.com/rotationalio/eirene>eirene: A client for collaborative Python development</a></li><li><a href=https://www.slideshare.net/RebeccaBilbro/conflictfree-replicated-data-types-pycon-2022>Enhancing Code Collaboration with Conflict-Free Replicated Data Types (PyCon 2022)</a></li><li><a href=https://www.inkandswitch.com/peritext/>Peritext: A CRDT for Rich-Text Collaboration</a></li><li><a href=https://youtu.be/PMVBuMK_pJY>Martin Kleppmann - CRDTs: The hard parts</a></li><li><a href=https://mwhittaker.github.io/consistency_in_distributed_systems/3_crdt.html>Michael Whittaker - Consistency in Distributed Systems</a></li></ul><h4 id=references>References</h4><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://static.googleusercontent.com/media/research.google.com/en//archive/paxos_made_live.pdf>Paxos Made Live - An Engineering Perspective</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://dl.acm.org/doi/10.1145/3465332.3470882>Scalable but wasteful: current state of replication in the cloud</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://github.com/rotationalio/eirene/blob/main/crdt/gset.py>Grow-Only Set</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://github.com/rotationalio/eirene/blob/main/crdt/gcounter.py>Grow-Only Counter</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://github.com/rotationalio/eirene/blob/main/crdt/sequence.py>Sequence CRDT</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><div class="bg-[#E8EFF6] max-w-[800px] mx-auto mt-9 p-8 rounded-lg"><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center mb-3"><span class="text-[#1D65A6] font-bold">About</span>
This Post</h3><p class="text-base mx-auto px-2 text-center lg:text-base">Conflict-free replicated data types are starting to take off in popularity, especially in terms of collaborative applications. In this post we will explore how these data structures can be used to achieve a total ordering of events across many peers.</p><div class="flex flex-col md:flex-row text-center mx-auto border-t pt-6 mt-6 align-center justify-between gap-10"><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Written by:</h2><div class="flex items-center"><a href=/authors/patrick-deziel><img src=img/team/patrick-deziel.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg"></a>
<span class="flex flex-wrap"><a href=/authors/patrick-deziel class="lg:w-[20ch] mx-2">Patrick Deziel</a></span></div></div><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Share this post:</h2><ul class="flex items-center justify-center gap-6 mt-4"><li><a onclick=shareByEmail() class=cursor-pointer><img src=img/email.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnTwitterWithTitle() class=cursor-pointer><img src=img/twitter.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnLinkedIn() class=cursor-pointer><img src=img/linkedin.png alt class="rounded-lg bg-white p-3"></a></li></ul></div></div></div><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class="flex justify-between mt-12 sm:mt-24 items-center"><div class="flex items-center"><h2 class="font-bold text-2xl sm:text-4xl flex"><span class=text-[#1D65A6]>Recommended</span>
&nbsp;Rotations</h2><img src=img/butterfly.png alt=butterfly class="ml-4 h-6 sm:h-8"></div><div><a href=/blog class="flex text-base sm:text-lg items-center font-bold text-[#1D65A6]"><span>View all</span>
<img src=img/arr-right.png alt class="h-4 ml-2"></a></div></div><div><div class="grid lg:grid-cols-2 xl:grid-cols-3 gap-8 sm:mt-16"><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/building-a-raft-part-3/><img src=https://rotational.io/img/blog/2023-02-07-building-a-raft-part-3/otterRaftThree.png alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/distributed-systems>Distributed Systems</a></li></ul><h3 class="text-xl font-extrabold mt-3 md:mt-4 pb-2"><a class="block h-auto lg:h-24" href=https://rotational.io/blog/building-a-raft-part-3/>Building a Raft (Part 3)</a></h3><div class='h-auto lg:h-36'><p class="mt-3 md:mt-4 text-base">In the third and final part of our series exploring the popular consensus algorithm we&rsquo;ll finally explore how Raft handles leader election, and in doing so discover how Raft is so incredibly resilient.</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6 xl:mt-8"><div class="flex items-center"><img src=img/team/daniel-sollis.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/daniel-sollis>Daniel Sollis</a></li></ul></div><div class=font-extralight>Feb 14, 2023</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/building-a-raft-part-1/><img src=https://rotational.io/img/blog/2022-12-19-building-a-raft-part-1/otterRaftOne.png alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/distributed-systems>Distributed Systems</a></li></ul><h3 class="text-xl font-extrabold mt-3 md:mt-4 pb-2"><a class="block h-auto lg:h-24" href=https://rotational.io/blog/building-a-raft-part-1/>Building a Raft (Part 1)</a></h3><div class='h-auto lg:h-36'><p class="mt-3 md:mt-4 text-base">With all the <a href=https://rotational.io/blog/six-things-you-didnt-know-about-crypto/>blockchain breaches</a> and <a href=https://rotational.io/blog/twitter-wont-disappear-overnight/>social media escapades</a>, there&rsquo;s been an awful lot of buzz about distributed systems lately. But how many of us really understand how they work? Let&rsquo;s dive in together&mldr;</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6 xl:mt-8"><div class="flex items-center"><img src=img/team/daniel-sollis.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/daniel-sollis>Daniel Sollis</a></li></ul></div><div class=font-extralight>Dec 19, 2022</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/twitter-wont-disappear-overnight/><img src=https://rotational.io/img/blog/2022-11-29-storm-clouds.jpg alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex flex-wrap"><li class="text-base font-bold text-[#1D65A6]"><a href=/tags/distributed-systems>Distributed Systems</a></li></ul><h3 class="text-xl font-extrabold mt-3 md:mt-4 pb-2"><a class="block h-auto lg:h-24" href=https://rotational.io/blog/twitter-wont-disappear-overnight/>No, Twitter Won't Disappear Overnight</a></h3><div class='h-auto lg:h-36'><p class="mt-3 md:mt-4 text-base">In this post we&rsquo;ll explore the question, how does a distributed system <em>actually</em> die?</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6 xl:mt-8"><div class="flex items-center"><img src=img/team/edwin-schmierer.png alt class="rounded-full h-10 w-10"><ul class="flex flex-wrap ml-4"><li class=font-extralight><a href=/authors/edwin-schmierer>Edwin Schmierer</a></li></ul></div><div class=font-extralight>Nov 29, 2022</div></div></div></div></div></div></div></div></div><div class="bg-[#1D65A6] max-w-[800px] mx-auto mt-20 py-14 px-12 md:px-16 text-white md:rounded-lg"><form action=blog method=post id=newsletterForm><h6 class="font-bold text-center">Enter Your Email To Subscribe</h6><label for=email class=hidden>Email</label>
<input type=text name=email id=email required placeholder class="w-full px-4 py-2.5 rounded-lg mt-6 text-black" style=color:#000><div class="flex mt-6 items-start gap-x-2"><input type=checkbox id=checkbox required class="mt-1 w-4 h-4 block border-0">
<label for=checkbox><span>I want to receive the monthly newsletter and other updates from Rotational. You agree to our Privacy Policy. You may unsubscribe at any time.*</span></label></div><div class="bg-teal-100 border-t-4 border-teal-500 mt-10 rounded-b text-teal-900 px-4 py-3 shadow-md hidden" id=newsletter-alert role=alert><div class=flex><div><p class=text-sm>Thank you for your interest!</p></div></div></div><div class="flex justify-center"><button type=submit class="bg-[#192E5B] px-14 py-4 mt-10 rounded-lg text-sm text-white uppercase md:text-base">
Submit</button></div></form></div></main><footer class="relative mt-40 md:mt-56 bg-[#192E5B]"><div class="relative w-full pt-36 md:pt-16 lg:pt-24 2xl:pt-20 font-extralight text-white"><div class="-mt-52 w-full mx-auto max-w-screen-xl px-4"><section class="bg-[#72A2C0] w-full p-6 md:py-20 md:px-16"><h2 class="my-4 text-2xl sm:text-3xl md:text-5xl text-white font-extrabold">LET'S ENVISION & BUILD THE FUTURE TOGETHER.</h2><div class=py-6><a href=mailto:hello@rotational.ai class="p-3 md:p-4 md:px-6 bg-[#2F4858] font-bold md:text-lg text-white text-center hover:bg-[#2F4858]/80">CONTACT US</a></div></section></div><div class="max-w-7xl mx-auto px-6"><div class="mt-12 flex flex-col md:flex-row lg:justify-between gap-x-8"><div class="my-4 max-w-xs"><h5 class="mb-3 font-extrabold">OUR PRESENCE</h5><p>We share because we care, about topics, tools, and technologies that we believe impact the AI economy.</p><div class=py-4><ul class="flex justify-between items-center gap-x-8"><li><a href=https://twitter.com/rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-x-twitter"></i><p class=sr-only>Twitter</p></a></li><li><a href=https://www.linkedin.com/company/rotational target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-linkedin"></i><p class=sr-only>LinkedIn</p></a></li><li><a href=https://github.com/rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-github"></i><p class=sr-only>GitHub</p></a></li><li><a href=https://www.youtube.com/@rotationalio target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-youtube"></i><p class=sr-only>YouTube</p></a></li><li><a href=https://www.twitch.tv/rotationallabs target=_blank class=hover:text-[#1D65A6]><i class="text-2xl fa-brands fa-twitch"></i><p class=sr-only>Twitch</p></a></li></ul></div></div><div class=my-4><h5 class="mb-3 font-extrabold">COMPANY</h5><ul><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/about>About Us</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/services>Services</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/case-studies>Case Studies</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/products>Product</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/blog>Blog</a></li></ul></div><div class=my-4><h5 class="mb-3 font-extrabold">COMMUNITY</h5><ul><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/resources>Learning</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/opensource>Open Source</a></li><li class="pb-3 flex items-center gap-x-2"><i class="fa-solid fa-chevron-right text-[#757575] text-xs"></i>
<a href=/ensign-u>Ensign U</a></li></ul></div><div class=my-4><h5 class="mb-3 font-extrabold">CONTACT US</h5><ul><li class="flex items-baseline lg:items-center gap-x-2"><i class="fa-solid fa-map-marker-alt text-[#757575]"></i>
St. Paul, MN & Washington, DC</li><li class="flex items-baseline lg:items-center gap-x-2"><i class="fa-solid fa-envelope text-[#757575]"></i>
hello@rotational.ai</li></ul><div class=py-8><a href=mailto:hello@rotational.ai class="p-3 bg-[#ECF6FF] font-bold text-black text-center hover:bg-[#ECF6FF]/80">CONTACT US</a></div></div></div><div class="sm:flex justify-between py-6 border-t mt-4"><p>Copyright © Rotational Labs, Inc. 2021–2024 · All Rights Reserved</p><div><ul class="sm:mt-0 mt-4 flex gap-x-8"><li><a href=/privacy/>Privacy Policy</a></li><li><a href=/terms/>Terms of Use</a></li></ul></div></div></div></div></footer><script src=https://unpkg.com/embla-carousel/embla-carousel.umd.js></script>
<script src=https://rotational.io/js/app.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js></script>
<script src=https://unpkg.com/@highlightjs/cdn-assets/highlight.min.js></script></body></html>