<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Transparently Mocking gRPC Services</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="gRPC is a common framework used to facilitate communication between microservices, but testing these services can be a challenge. In this post we will present a simple strategy for mocking gRPC services in Go."><meta name=author content="Rotational Labs, LLC"><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=https://rotational.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://rotational.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://rotational.io/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://rotational.io/plugins/slick/slick.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Anaheim%7cQuattrocento+Sans:400,700&display=swap"><link rel=stylesheet href=https://rotational.io/css/style.min.css media=screen><link rel=stylesheet href=https://rotational.io/css/custom.min.css media=screen><link rel="shortcut icon" href=https://rotational.io/images/assets/icons/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/images/assets/icons/favicon.png type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-2FKX6CWJHW')</script></head><body id=body data-spy=scroll data-target=.navbar data-offset=55><div id=content><section class="sticky-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-dark"><a class="navbar-brand p-0" href=/><img class=lozad data-src=https://rotational.io/images/assets/logos/logo.png alt="Rotational Labs" height=57></a>
<button class="navbar-toggler rounded-0" type=button data-toggle=collapse data-target=#navigation>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://rotational.io/#about>about</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#services>services</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#team>team</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/blog>blog</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#contact>contact</a></li></ul><select id=select-language onchange="location=this.value"><option id=en value=https://rotational.io/blog/transparently-mocking-grpc-services/ selected>En</option></select></div></nav></div></section><section class=section><div class=container><div class=row><div class="col-lg-8 offset-lg-2 text-center"><h1>Transparently Mocking gRPC Services</h1><ul class="list-inline mb-50"><li class=list-inline-item><a href=/author/patrick-deziel/>Patrick Deziel</a></li><li class=list-inline-item>Friday, Jul 8, 2022</li></ul><img class="img-fluid mb-50 lozad" data-src=https://rotational.io/images/blog/blue_laser.jpg alt=blog-image></div><div class="col-lg-8 offset-lg-2"><div class=post-single-content><p>gRPC is an effective way of implementing service-to-service APIs. However, there are limited tools available for mocking and testing gRPC services out of the box. One option is to set up a live test server, although this comes with its own challenges and costs. In this blog post we will demonstrate a more lightweight solution using the <code>bufconn</code> package and a hand-built mock. Don&rsquo;t worry, this is easier than it seems!</p><p>Before we get started, the full tutorial code is available <a href=https://github.com/rotationalio/agenda>here</a>.</p><h2 id=the-api>The API</h2><p>We usually start by defining the API for our service, as it can inform many decisions related to implementation. For simplicity, we&rsquo;ll create an &ldquo;agenda&rdquo; service in our <code>.proto</code> file, which contains two RPC definitions and some protocol buffers. The <code>Schedule</code> RPC will allow the client to schedule items on the agenda and the <code>Daily</code> RPC will return a list of scheduled items to the client.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#6ab825;font-weight:700>service</span> Agenda {<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>rpc</span> Schedule(Item) <span style=color:#6ab825;font-weight:700>returns</span> (Item) {}<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>rpc</span> Daily(Day) <span style=color:#6ab825;font-weight:700>returns</span> (Docket) {}<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>}<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>message</span> <span style=color:#447fcf;text-decoration:underline>Item</span> {<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> id = <span style=color:#3677a9>1</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> title = <span style=color:#3677a9>2</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> date = <span style=color:#3677a9>3</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> start = <span style=color:#3677a9>4</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> end = <span style=color:#3677a9>5</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> description = <span style=color:#3677a9>6</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>}<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>message</span> <span style=color:#447fcf;text-decoration:underline>Day</span> {<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> date = <span style=color:#3677a9>1</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> start = <span style=color:#3677a9>2</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> end = <span style=color:#3677a9>3</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>}<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>message</span> <span style=color:#447fcf;text-decoration:underline>Docket</span> {<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>string</span> date = <span style=color:#3677a9>1</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#6ab825;font-weight:700>repeated</span> Item items = <span style=color:#3677a9>2</span>;<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>}<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><h2 id=mocking-communication>Mocking Communication</h2><p>In order to test our gRPC service, we will need to inject a mocked connection. Fortunately, there is a package called <code>bufconn</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, which does most of the heavy lifting for us. <code>bufconn</code> gives us two things, a way to start an in-memory buffered listener and a way to connect to that listener using a <code>grpc.DialOption</code>. We have found it useful to abstract this functionality into a &ldquo;utils&rdquo; package.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>const</span> bufsize = <span style=color:#3677a9>1024</span> * <span style=color:#3677a9>1024</span>

<span style=color:#6ab825;font-weight:700>type</span> Listener <span style=color:#6ab825;font-weight:700>struct</span> {
	sock *bufconn.Listener
}

<span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>New</span>() *Listener {
	<span style=color:#6ab825;font-weight:700>return</span> &amp;Listener{
		sock: bufconn.<span style=color:#447fcf>Listen</span>(bufsize),
	}
}

<span style=color:#6ab825;font-weight:700>func</span> (l *Listener) <span style=color:#447fcf>Sock</span>() net.Listener {
	<span style=color:#6ab825;font-weight:700>return</span> l.sock
}

<span style=color:#6ab825;font-weight:700>func</span> (l *Listener) <span style=color:#447fcf>Close</span>() <span style=color:#6ab825;font-weight:700>error</span> {
	<span style=color:#6ab825;font-weight:700>return</span> l.sock.<span style=color:#447fcf>Close</span>()
}

<span style=color:#6ab825;font-weight:700>func</span> (l *Listener) <span style=color:#447fcf>Connect</span>(ctx context.Context, opts ...grpc.DialOption) (cc *grpc.ClientConn, err <span style=color:#6ab825;font-weight:700>error</span>) {
	opts = <span style=color:#24909d>append</span>([]grpc.DialOption{grpc.<span style=color:#447fcf>WithContextDialer</span>(l.Dialer)}, opts...)
	<span style=color:#6ab825;font-weight:700>if</span> cc, err = grpc.<span style=color:#447fcf>DialContext</span>(ctx, <span style=color:#ed9d13>&#34;bufnet&#34;</span>, opts...); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>, err
	}
	<span style=color:#6ab825;font-weight:700>return</span> cc, <span style=color:#6ab825;font-weight:700>nil</span>
}

<span style=color:#6ab825;font-weight:700>func</span> (l *Listener) <span style=color:#447fcf>Dialer</span>(context.Context, <span style=color:#6ab825;font-weight:700>string</span>) (net.Conn, <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#6ab825;font-weight:700>return</span> l.sock.<span style=color:#447fcf>Dial</span>()
}
</code></pre></div><h2 id=creating-the-server>Creating the Server</h2><p>Our server setup is fairly idiomatic aside from one important detail: we don&rsquo;t want our testing code to start a &ldquo;real&rdquo; server since we are mocking that with <code>bufconn</code>. Therefore, our <code>Serve</code> function is separated into <code>Serve</code> and <code>Run</code>. This will allow our tests to pass in a <code>net.Listener</code> object obtained from <code>bufconn</code> rather than a connection address. The exciting part about this is that it completely isolates the mock code from the production server code!</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>type</span> Server <span style=color:#6ab825;font-weight:700>struct</span> {
	api.UnimplementedAgendaServer
	srv   *grpc.Server
	echan <span style=color:#6ab825;font-weight:700>chan</span> <span style=color:#6ab825;font-weight:700>error</span>
}

<span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>New</span>() (*Server, <span style=color:#6ab825;font-weight:700>error</span>) {
	s := &amp;Server{
		echan: <span style=color:#24909d>make</span>(<span style=color:#6ab825;font-weight:700>chan</span> <span style=color:#6ab825;font-weight:700>error</span>, <span style=color:#3677a9>1</span>),
	}

	<span style=color:#999;font-style:italic>// Create the gRPC Server
</span><span style=color:#999;font-style:italic></span>	s.srv = grpc.<span style=color:#447fcf>NewServer</span>()
	api.<span style=color:#447fcf>RegisterAgendaServer</span>(s.srv, s)
	<span style=color:#6ab825;font-weight:700>return</span> s, <span style=color:#6ab825;font-weight:700>nil</span>
}

<span style=color:#999;font-style:italic>// The test code will not call this function
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *Server) <span style=color:#447fcf>Serve</span>(addr <span style=color:#6ab825;font-weight:700>string</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#999;font-style:italic>// Catch OS signals for graceful shutdowns
</span><span style=color:#999;font-style:italic></span>	quit := <span style=color:#24909d>make</span>(<span style=color:#6ab825;font-weight:700>chan</span> os.Signal, <span style=color:#3677a9>1</span>)
	signal.<span style=color:#447fcf>Notify</span>(quit, os.Interrupt)
	<span style=color:#6ab825;font-weight:700>go</span> <span style=color:#6ab825;font-weight:700>func</span>() {
		&lt;-quit
		s.echan &lt;- s.<span style=color:#447fcf>Shutdown</span>()
	}()

	<span style=color:#999;font-style:italic>// Listen for TCP requests on the specified address and port
</span><span style=color:#999;font-style:italic></span>	<span style=color:#6ab825;font-weight:700>var</span> sock net.Listener
	<span style=color:#6ab825;font-weight:700>if</span> sock, err = net.<span style=color:#447fcf>Listen</span>(<span style=color:#ed9d13>&#34;tcp&#34;</span>, addr); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;could not listen on %q&#34;</span>, addr)
	}

	<span style=color:#999;font-style:italic>// Run the server
</span><span style=color:#999;font-style:italic></span>	<span style=color:#6ab825;font-weight:700>go</span> s.<span style=color:#447fcf>Run</span>(sock)
	log.<span style=color:#447fcf>Info</span>().<span style=color:#447fcf>Str</span>(<span style=color:#ed9d13>&#34;listen&#34;</span>, addr).<span style=color:#447fcf>Str</span>(<span style=color:#ed9d13>&#34;version&#34;</span>, pkg.<span style=color:#447fcf>Version</span>()).<span style=color:#447fcf>Msg</span>(<span style=color:#ed9d13>&#34;agenda server started&#34;</span>)

	<span style=color:#999;font-style:italic>// Block and wait for an error either from shutdown or grpc.
</span><span style=color:#999;font-style:italic></span>	<span style=color:#6ab825;font-weight:700>if</span> err = &lt;-s.echan; err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> err
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}

<span style=color:#999;font-style:italic>// The test code can pass in a bufconn listener here
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *Server) <span style=color:#447fcf>Run</span>(sock net.Listener) {
	<span style=color:#6ab825;font-weight:700>defer</span> sock.<span style=color:#447fcf>Close</span>()
	<span style=color:#6ab825;font-weight:700>if</span> err := s.srv.<span style=color:#447fcf>Serve</span>(sock); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		s.echan &lt;- err
	}
}
</code></pre></div><h2 id=creating-the-client>Creating the Client</h2><p>For the client implementation, we take advantage of variadic arguments to implement a similar isolation strategy. When initializing the client, the caller can pass in any number of <code>grpc.DialOption</code> parameters (even zero). In production, we may want to pass in mTLS or other options here. For testing, we will pass in the dialer from <code>bufconn</code>.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>type</span> Client <span style=color:#6ab825;font-weight:700>struct</span> {
	cc  *grpc.ClientConn
	rpc api.AgendaClient
}

<span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>New</span>(endpoint <span style=color:#6ab825;font-weight:700>string</span>, opts ...grpc.DialOption) (c *Client, err <span style=color:#6ab825;font-weight:700>error</span>) {
	c = &amp;Client{}

	<span style=color:#6ab825;font-weight:700>if</span> <span style=color:#24909d>len</span>(opts) == <span style=color:#3677a9>0</span> {
		<span style=color:#999;font-style:italic>// Production connection opts (TLS, etc.)
</span><span style=color:#999;font-style:italic></span>		opts = <span style=color:#24909d>make</span>([]grpc.DialOption, <span style=color:#3677a9>0</span>)
		opts = <span style=color:#24909d>append</span>(opts, grpc.<span style=color:#447fcf>WithTransportCredentials</span>(insecure.<span style=color:#447fcf>NewCredentials</span>()))
	}

	<span style=color:#6ab825;font-weight:700>if</span> c.cc, err = grpc.<span style=color:#447fcf>Dial</span>(endpoint, opts...); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>, err
	}
	c.rpc = api.<span style=color:#447fcf>NewAgendaClient</span>(c.cc)

	<span style=color:#6ab825;font-weight:700>return</span> c, <span style=color:#6ab825;font-weight:700>nil</span>
}

<span style=color:#6ab825;font-weight:700>func</span> (c *Client) <span style=color:#447fcf>Close</span>() <span style=color:#6ab825;font-weight:700>error</span> {
	<span style=color:#6ab825;font-weight:700>return</span> c.cc.<span style=color:#447fcf>Close</span>()
}
</code></pre></div><h2 id=the-server-mock>The Server Mock</h2><p>In previous blog posts, we have discussed the importance of isolation and configurability of mocks. We will now demonstrate these concepts by creating an independent mock for the <code>AgendaServer</code> in a different package that we can easily utilize from the tests. The key is to use the <code>bufconn</code> utilities that we created earlier to start the server by calling <code>Run</code> and create an accessor for the tests to access the client side of the <code>bufconn</code> connection.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>const</span> (
	DailyRPC    = <span style=color:#ed9d13>&#34;agenda.v1.Agenda/Daily&#34;</span>
	ScheduleRPC = <span style=color:#ed9d13>&#34;agenda.v1.Agenda/Schedule&#34;</span>
)

<span style=color:#999;font-style:italic>// New creates a new mock AgendaServer. If bufnet is nil, one is created for the user.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>New</span>(bufnet *utils.Listener) *AgendaServer {
	<span style=color:#6ab825;font-weight:700>if</span> bufnet == <span style=color:#6ab825;font-weight:700>nil</span> {
		bufnet = utils.<span style=color:#447fcf>New</span>()
	}

	remote := &amp;AgendaServer{
		bufnet: bufnet,
		srv:    grpc.<span style=color:#447fcf>NewServer</span>(),
		Calls:  <span style=color:#24909d>make</span>(<span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>string</span>]<span style=color:#6ab825;font-weight:700>int</span>),
	}

	api.<span style=color:#447fcf>RegisterAgendaServer</span>(remote.srv, remote)
	<span style=color:#6ab825;font-weight:700>go</span> remote.srv.<span style=color:#447fcf>Run</span>(remote.bufnet.<span style=color:#447fcf>Sock</span>())
	<span style=color:#6ab825;font-weight:700>return</span> remote
}

<span style=color:#6ab825;font-weight:700>type</span> AgendaServer <span style=color:#6ab825;font-weight:700>struct</span> {
	api.UnimplementedAgendaServer
	bufnet     *utils.Listener
	srv        *grpc.Server
	Calls      <span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>string</span>]<span style=color:#6ab825;font-weight:700>int</span>
	OnSchedule <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Item) (*api.Item, <span style=color:#6ab825;font-weight:700>error</span>)
	OnDaily    <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Day) (*api.Docket, <span style=color:#6ab825;font-weight:700>error</span>)
}

<span style=color:#999;font-style:italic>// Tests can call this to get access to the bufconn
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>Channel</span>() *utils.Listener {
	<span style=color:#6ab825;font-weight:700>return</span> s.bufnet
}

<span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>Shutdown</span>() {
	s.srv.<span style=color:#447fcf>GracefulStop</span>()
	s.bufnet.<span style=color:#447fcf>Close</span>()
}
</code></pre></div><p>Note that we have included a call counter on the <code>AgendaServer</code>. This allows us to verify from the tests what methods have been called via the gRPC server.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>Daily</span>(ctx context.Context, in *api.Day) (out *api.Docket, err <span style=color:#6ab825;font-weight:700>error</span>) {
	s.Calls[DailyRPC]++
	<span style=color:#6ab825;font-weight:700>return</span> s.<span style=color:#447fcf>OnDaily</span>(ctx, in)
}

<span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>Schedule</span>(ctx context.Context, in *api.Item) (out *api.Item, err <span style=color:#6ab825;font-weight:700>error</span>) {
	s.Calls[ScheduleRPC]++
	<span style=color:#6ab825;font-weight:700>return</span> s.<span style=color:#447fcf>OnSchedule</span>(ctx, in)
}
</code></pre></div><p>The mock also gives us the ability to configure how the gRPC handlers will behave. For example, we might want to test how our code deals with errors or specific responses from the handlers.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#999;font-style:italic>// UseFixture loads a a JSON fixture from disk (usually in a testdata folder) to use as
</span><span style=color:#999;font-style:italic>// the protocol buffer response to the specified RPC, simplifying handler mocking.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>UseFixture</span>(rpc, path <span style=color:#6ab825;font-weight:700>string</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#6ab825;font-weight:700>var</span> data []<span style=color:#6ab825;font-weight:700>byte</span>
	<span style=color:#6ab825;font-weight:700>if</span> data, err = ioutil.<span style=color:#447fcf>ReadFile</span>(path); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;could not read fixture: %v&#34;</span>, err)
	}

	jsonpb := &amp;protojson.UnmarshalOptions{
		AllowPartial:   <span style=color:#6ab825;font-weight:700>true</span>,
		DiscardUnknown: <span style=color:#6ab825;font-weight:700>true</span>,
	}

	<span style=color:#6ab825;font-weight:700>switch</span> rpc {
	<span style=color:#6ab825;font-weight:700>case</span> ScheduleRPC:
		out := &amp;api.Item{}
		<span style=color:#6ab825;font-weight:700>if</span> err = jsonpb.<span style=color:#447fcf>Unmarshal</span>(data, out); err != <span style=color:#6ab825;font-weight:700>nil</span> {
			<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;could not unmarshal json into %T: %v&#34;</span>, out, err)
		}
		s.OnSchedule = <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Item) (*api.Item, <span style=color:#6ab825;font-weight:700>error</span>) {
			<span style=color:#6ab825;font-weight:700>return</span> out, <span style=color:#6ab825;font-weight:700>nil</span>
		}
	<span style=color:#6ab825;font-weight:700>case</span> DailyRPC:
		out := &amp;api.Docket{}
		<span style=color:#6ab825;font-weight:700>if</span> err = jsonpb.<span style=color:#447fcf>Unmarshal</span>(data, out); err != <span style=color:#6ab825;font-weight:700>nil</span> {
			<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;could not unmarshal json into %T: %v&#34;</span>, out, err)
		}
		s.OnDaily = <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Day) (*api.Docket, <span style=color:#6ab825;font-weight:700>error</span>) {
			<span style=color:#6ab825;font-weight:700>return</span> out, <span style=color:#6ab825;font-weight:700>nil</span>
		}
	<span style=color:#6ab825;font-weight:700>default</span>:
		<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;unknown RPC %q&#34;</span>, rpc)
	}

	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}

<span style=color:#999;font-style:italic>// UseError allows you to specify a gRPC status error to return from the specified RPC.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *AgendaServer) <span style=color:#447fcf>UseError</span>(rpc <span style=color:#6ab825;font-weight:700>string</span>, code codes.Code, msg <span style=color:#6ab825;font-weight:700>string</span>) <span style=color:#6ab825;font-weight:700>error</span> {
	<span style=color:#6ab825;font-weight:700>switch</span> rpc {
	<span style=color:#6ab825;font-weight:700>case</span> ScheduleRPC:
		s.OnSchedule = <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Item) (*api.Item, <span style=color:#6ab825;font-weight:700>error</span>) {
			<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>, status.<span style=color:#447fcf>Error</span>(code, msg)
		}
	<span style=color:#6ab825;font-weight:700>case</span> DailyRPC:
		s.OnDaily = <span style=color:#6ab825;font-weight:700>func</span>(context.Context, *api.Day) (*api.Docket, <span style=color:#6ab825;font-weight:700>error</span>) {
			<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>, status.<span style=color:#447fcf>Error</span>(code, msg)
		}
	<span style=color:#6ab825;font-weight:700>default</span>:
		<span style=color:#6ab825;font-weight:700>return</span> fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;unknown RPC %q&#34;</span>, rpc)
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><h2 id=putting-it-all-together>Putting It All Together</h2><p>With our mock package, writing gRPC tests becomes more of a matter of <em>what</em> we want to test rather than <em>how</em> to test it. The test below verifies that our mock works by simulting an error path and a &ldquo;happy&rdquo; path.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>TestSchedule</span>(t *testing.T) {
	<span style=color:#999;font-style:italic>// Setup AgendaServer mock
</span><span style=color:#999;font-style:italic></span>	srv := mock.<span style=color:#447fcf>New</span>(<span style=color:#6ab825;font-weight:700>nil</span>)
	<span style=color:#6ab825;font-weight:700>defer</span> srv.<span style=color:#447fcf>Shutdown</span>()

	<span style=color:#999;font-style:italic>// Create a client to test that is connected to the mock server.
</span><span style=color:#999;font-style:italic></span>	dialer := grpc.<span style=color:#447fcf>WithContextDialer</span>(srv.<span style=color:#447fcf>Channel</span>().Dialer)
	creds := grpc.<span style=color:#447fcf>WithTransportCredentials</span>(insecure.<span style=color:#447fcf>NewCredentials</span>())
	agenda, err := client.<span style=color:#447fcf>New</span>(<span style=color:#ed9d13>&#34;bufconn&#34;</span>, dialer, creds)
	require.<span style=color:#447fcf>NoError</span>(t, err, <span style=color:#ed9d13>&#34;could not connect to remote agenda via bufconn&#34;</span>)

	<span style=color:#999;font-style:italic>// Test the case where the server returns an error
</span><span style=color:#999;font-style:italic></span>	srv.<span style=color:#447fcf>UseError</span>(mock.ScheduleRPC, codes.DataLoss, <span style=color:#ed9d13>&#34;something bad happened&#34;</span>)
	err = agenda.<span style=color:#447fcf>Schedule</span>(<span style=color:#ed9d13>&#34;hello&#34;</span>, <span style=color:#ed9d13>&#34;world&#34;</span>, time.<span style=color:#447fcf>Now</span>(), time.<span style=color:#447fcf>Now</span>().<span style=color:#447fcf>Add</span>(<span style=color:#3677a9>5</span>*time.Minute))
	require.<span style=color:#447fcf>Error</span>(t, err, <span style=color:#ed9d13>&#34;expected an error returned from the server&#34;</span>)
	require.<span style=color:#447fcf>Equal</span>(t, <span style=color:#3677a9>1</span>, srv.Calls[mock.ScheduleRPC])

	<span style=color:#999;font-style:italic>// Test the case where server returns a response
</span><span style=color:#999;font-style:italic></span>	srv.<span style=color:#447fcf>UseFixture</span>(mock.ScheduleRPC, <span style=color:#ed9d13>&#34;testdata/item.json&#34;</span>)
	err = agenda.<span style=color:#447fcf>Schedule</span>(<span style=color:#ed9d13>&#34;hello&#34;</span>, <span style=color:#ed9d13>&#34;world&#34;</span>, time.<span style=color:#447fcf>Now</span>(), time.<span style=color:#447fcf>Now</span>().<span style=color:#447fcf>Add</span>(<span style=color:#3677a9>5</span>*time.Minute))
	require.<span style=color:#447fcf>NoError</span>(t, err, <span style=color:#ed9d13>&#34;expected no error in happy path&#34;</span>)
	require.<span style=color:#447fcf>Equal</span>(t, <span style=color:#3677a9>2</span>, srv.Calls[mock.ScheduleRPC])
}
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>Mocking gRPC services for the purposes of testing isn&rsquo;t always straightforward. However, with tools like <code>bufconn</code> and some clever code factoring, we can create an in-memory mock that is completely isolated from production code. Introducing some measure of configurability into the mocks can also help us focus on <em>what</em> we&rsquo;re testing rather than <em>how</em> we&rsquo;re testing it.</p><p>Check out the full tutorial code <a href=https://github.com/rotationalio/agenda>here</a>.</p><hr><p>Photo by <a href="https://unsplash.com/@jjying?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">JJ Ying</a> on <a href="https://unsplash.com/s/photos/technology?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></p><hr><h4 id=references>References</h4><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://pkg.go.dev/google.golang.org/grpc/test/bufconn>bufconn</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class="social-share pt-4"><h4>Share:</h4><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Transparently%20Mocking%20gRPC%20Services&url=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://plus.google.com/share?url=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--google resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.37 12.93c-.73-.52-1.4-1.27-1.4-1.5.0-.43.03-.63.98-1.37 1.23-.97 1.9-2.23 1.9-3.57.0-1.22-.36-2.3-1-3.05h.5c.1.0.2-.04.28-.1l1.36-.98c.16-.12.23-.34.17-.54-.07-.2-.25-.33-.46-.33H7.6c-.66.0-1.34.12-2 .35-2.23.76-3.78 2.66-3.78 4.6.0 2.76 2.13 4.85 5 4.9-.07.23-.1.45-.1.66.0.43.1.83.33 1.22h-.08c-2.72.0-5.17 1.34-6.1 3.32-.25.52-.37 1.04-.37 1.56.0.5.13.98.38 1.44.6 1.04 1.84 1.86 3.55 2.28.87.23 1.82.34 2.8.34.88.0 1.7-.1 2.5-.34 2.4-.7 3.97-2.48 3.97-4.54.0-1.97-.63-3.15-2.33-4.35zm-7.7 4.5c0-1.42 1.8-2.68 3.9-2.68h.05c.45.0.9.07 1.3.2l.42.28c.96.66 1.6 1.1 1.77 1.8.05.16.07.33.07.5.0 1.8-1.33 2.7-3.96 2.7-1.98.0-3.54-1.23-3.54-2.8zM5.54 3.9c.33-.38.75-.58 1.23-.58h.05c1.35.05 2.64 1.55 2.88 3.35.14 1.02-.08 1.97-.6 2.55-.32.37-.74.56-1.23.56h-.03c-1.32-.04-2.63-1.6-2.87-3.4-.13-1 .08-1.92.58-2.5zM23.5 9.5h-3v-3h-2v3h-3v2h3v3h2v-3h3"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Transparently%20Mocking%20gRPC%20Services&body=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_self rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f&resubmit=true&title=Transparently%20Mocking%20gRPC%20Services" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Transparently%20Mocking%20gRPC%20Services%20https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=Transparently%20Mocking%20gRPC%20Services&url=https%3a%2f%2frotational.io%2fblog%2ftransparently-mocking-grpc-services%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64.0 9.508.0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102.0 001.75.527l2.96-2.41a.405.405.0 01.494-.013l5.34 3.87a1.1 1.1.0 001.046.135 1.1 1.1.0 00.682-.803l3.91-18.795A1.102 1.102.0 0022.5.075L.706 8.475z"/></svg></div></div></a></div><div class=mt-5></div></div></div></div></section></div><footer id=footer class=section-bg><div class=container><div class="row wow fadeInUp" data-wow-duration=500ms><div class=col-xl-12><div class=social-icon><ul class=list-inline><li class=list-inline-item><a href=https://twitter.com/rotationalio target=_blank><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://github.com/rotationalio target=_blank><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/rotational/ target=_blank><i class=ti-linkedin></i></a></li></ul></div><div class="copyright text-center"><a href=https://rotational.io/><img src=https://rotational.io/images/assets/logos/logo.png alt="Rotational Labs" height=92></a><br><p>Copyright © 2021 Rotational Labs, LLC, All Rights Reserved</p></div></div></div></div></footer><script src=https://rotational.io/plugins/jquery/jquery.min.js></script><script src=https://rotational.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://rotational.io/plugins/slick/slick.min.js></script><script src=https://rotational.io/plugins/shuffle/shuffle.min.js></script><script src=https://rotational.io/plugins/magnific-popup/jquery.magnific-popup.min.js></script><script src=https://rotational.io/plugins/lazy-load/lozad.min.js></script><script src=https://rotational.io/plugins/google-map/map.js></script><script src=https://rotational.io/js/script.min.5db5ae6f88052715e823d7c52f3fa7a832565352b0f76c1d2cee2a3b564a0716fa9d51878a9965389c3d856f2d7c6330.js integrity=sha384-XbWub4gFJxXoI9fFLz+nqDJWU1Kw92wdLO4qO1ZKBxb6nVGHipllOJw9hW8tfGMw></script></body></html>