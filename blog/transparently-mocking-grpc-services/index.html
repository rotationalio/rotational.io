<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=twitter:card content="summary"><meta property="og:image" content="https://rotational.io/img/blog/blue_laser.jpg"><meta name=twitter:image content="https://rotational.io/img/blog/blue_laser.jpg"><meta property="og:title" content="Transparently Mocking gRPC Services"><meta name=twitter:title content="Transparently Mocking gRPC Services"><meta property="og:description" content="gRPC is a common framework used to facilitate communication between microservices, but testing these services can be a challenge. In this post we will present a simple strategy for mocking gRPC services in Go."><meta name=twitter:description content="gRPC is a common framework used to facilitate communication between microservices, but testing these services can be a challenge. In this post we will present a simple strategy for mocking gRPC services in Go."><meta name=author content="Rotational Labs, LLC"><base href=https://rotational.io/><title>Rotational Labs | Transparently Mocking gRPC Services</title><link rel="shortcut icon" href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,600;1,700;1,800&display=swap" rel=stylesheet><link rel=stylesheet href=https://rotational.io/output.css media=screen><script async src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2FKX6CWJHW")</script><script src=https://kit.fontawesome.com/2c36e9b7b1.js crossorigin=anonymous></script>
<script src="https://www.google.com/recaptcha/enterprise.js?render="></script>
<script>grecaptcha.enterprise.ready(function(){grecaptcha.enterprise.execute("6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk",{action:"homepage"}).then(function(){})})</script></head><body class="bg-hexagon bg-center bg-contain"><div class="sm:pt-5 pb-6 relative bg-[#1D65A6]"><nav class="relative max-w-7xl mx-auto flex items-center justify-between text-white px-4 sm:px-6" aria-label=Global><a href=/ class=pt-3><img src=img/logo.png alt="Rotational Lab logo" class="h-14 w-auto sm:h-14"></a><div class=topnav id=myTopnav><a href=/ensign/>Ensign</a>
<a href=/services/>Services</a>
<a href=/opensource/>Open Source</a>
<a href=/blog/>Blog</a>
<a href=/about/>About</a>
<a href=/contact/>Contact Us</a>
<a class="icon mt-4" onclick=openMobNav()><i class="fa fa-bars"></i></a></div></nav></div><main><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class=mt-14><div class=blog-img><img src=https://rotational.io/img/blog/blue_laser.jpg alt="Transparently Mocking gRPC Services" class=mx-auto></div><div class=mt-8><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center" data-blog-title="Transparently Mocking gRPC Services"><b class=text-[#1D65A6]>Transparently</b>
Mocking gRPC Services</h3><div class="flex justify-center items-center mt-4 mb-6"><img src=img/team/patrick-deziel.png alt class="border-4 border-white rounded-full h-11 drop-shadow-lg"><span class=ml-3>Patrick Deziel |
Friday, Jul 8, 2022 | gRPC, Mocks, Programming</span></div><div class="max-w-[800px] mx-auto prose prose-blue"><p>gRPC is an effective way of implementing service-to-service APIs. However, there are limited tools available for mocking and testing gRPC services out of the box. One option is to set up a live test server, although this comes with its own challenges and costs. In this blog post we will demonstrate a more lightweight solution using the <code>bufconn</code> package and a hand-built mock. Don&rsquo;t worry, this is easier than it seems!</p><p>Before we get started, the full tutorial code is available <a href=https://github.com/rotationalio/agenda>here</a>.</p><h2 id=the-api>The API</h2><p>We usually start by defining the API for our service, as it can inform many decisions related to implementation. For simplicity, we&rsquo;ll create an &ldquo;agenda&rdquo; service in our <code>.proto</code> file, which contains two RPC definitions and some protocol buffers. The <code>Schedule</code> RPC will allow the client to schedule items on the agenda and the <code>Daily</code> RPC will return a list of scheduled items to the client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>service</span> Agenda {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>rpc</span> Schedule(Item) <span style=color:#66d9ef>returns</span> (Item) {}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>rpc</span> Daily(Day) <span style=color:#66d9ef>returns</span> (Docket) {}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Item</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> title <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> date <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> start <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> end <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> description <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Day</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> date <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> start <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> end <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Docket</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>string</span> date <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>repeated</span> Item items <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=mocking-communication>Mocking Communication</h2><p>In order to test our gRPC service, we will need to inject a mocked connection. Fortunately, there is a package called <code>bufconn</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, which does most of the heavy lifting for us. <code>bufconn</code> gives us two things, a way to start an in-memory buffered listener and a way to connect to that listener using a <code>grpc.DialOption</code>. We have found it useful to abstract this functionality into a &ldquo;utils&rdquo; package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bufsize</span> = <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Listener</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sock</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bufconn</span>.<span style=color:#a6e22e>Listener</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Listener</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Listener</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sock</span>: <span style=color:#a6e22e>bufconn</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#a6e22e>bufsize</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Listener</span>) <span style=color:#a6e22e>Sock</span>() <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listener</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>sock</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Listener</span>) <span style=color:#a6e22e>Close</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Listener</span>) <span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialOption</span>) (<span style=color:#a6e22e>cc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>opts</span> = append([]<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialOption</span>{<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithContextDialer</span>(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Dialer</span>)}, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;bufnet&#34;</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cc</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Listener</span>) <span style=color:#a6e22e>Dialer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>Dial</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=creating-the-server>Creating the Server</h2><p>Our server setup is fairly idiomatic aside from one important detail: we don&rsquo;t want our testing code to start a &ldquo;real&rdquo; server since we are mocking that with <code>bufconn</code>. Therefore, our <code>Serve</code> function is separated into <code>Serve</code> and <code>Run</code>. This will allow our tests to pass in a <code>net.Listener</code> object obtained from <code>bufconn</code> rather than a connection address. The exciting part about this is that it completely isolates the mock code from the production server code!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>UnimplementedAgendaServer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>srv</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Server</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>echan</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>echan</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create the gRPC Server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>srv</span> = <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>NewServer</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>RegisterAgendaServer</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>srv</span>, <span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The test code will not call this function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>) <span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Catch OS signals for graceful shutdowns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>quit</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>quit</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>quit</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>echan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Shutdown</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Listen for TCP requests on the specified address and port
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sock</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listener</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sock</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>addr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not listen on %q&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Run the server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>sock</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>().<span style=color:#a6e22e>Str</span>(<span style=color:#e6db74>&#34;listen&#34;</span>, <span style=color:#a6e22e>addr</span>).<span style=color:#a6e22e>Str</span>(<span style=color:#e6db74>&#34;version&#34;</span>, <span style=color:#a6e22e>pkg</span>.<span style=color:#a6e22e>Version</span>()).<span style=color:#a6e22e>Msg</span>(<span style=color:#e6db74>&#34;agenda server started&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Block and wait for an error either from shutdown or grpc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>echan</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The test code can pass in a bufconn listener here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>sock</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listener</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>sock</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>echan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=creating-the-client>Creating the Client</h2><p>For the client implementation, we take advantage of variadic arguments to implement a similar isolation strategy. When initializing the client, the caller can pass in any number of <code>grpc.DialOption</code> parameters (even zero). In production, we may want to pass in mTLS or other options here. For testing, we will pass in the dialer from <code>bufconn</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Client</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cc</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rpc</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>AgendaClient</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>endpoint</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialOption</span>) (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Client</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>opts</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Production connection opts (TLS, etc.)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>opts</span> = make([]<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialOption</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithTransportCredentials</span>(<span style=color:#a6e22e>insecure</span>.<span style=color:#a6e22e>NewCredentials</span>()))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>rpc</span> = <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>NewAgendaClient</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cc</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Client</span>) <span style=color:#a6e22e>Close</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=the-server-mock>The Server Mock</h2><p>In previous blog posts, we have discussed the importance of isolation and configurability of mocks. We will now demonstrate these concepts by creating an independent mock for the <code>AgendaServer</code> in a different package that we can easily utilize from the tests. The key is to use the <code>bufconn</code> utilities that we created earlier to start the server by calling <code>Run</code> and create an accessor for the tests to access the client side of the <code>bufconn</code> connection.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>DailyRPC</span>    = <span style=color:#e6db74>&#34;agenda.v1.Agenda/Daily&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ScheduleRPC</span> = <span style=color:#e6db74>&#34;agenda.v1.Agenda/Schedule&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New creates a new mock AgendaServer. If bufnet is nil, one is created for the user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>bufnet</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>Listener</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bufnet</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bufnet</span> = <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>remote</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AgendaServer</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bufnet</span>: <span style=color:#a6e22e>bufnet</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>srv</span>:    <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>NewServer</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Calls</span>:  make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>RegisterAgendaServer</span>(<span style=color:#a6e22e>remote</span>.<span style=color:#a6e22e>srv</span>, <span style=color:#a6e22e>remote</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>remote</span>.<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>remote</span>.<span style=color:#a6e22e>bufnet</span>.<span style=color:#a6e22e>Sock</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>remote</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AgendaServer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>UnimplementedAgendaServer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bufnet</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>Listener</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>srv</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Server</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Calls</span>      <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>OnSchedule</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>OnDaily</span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Day</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Docket</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Tests can call this to get access to the bufconn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>Channel</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>Listener</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>bufnet</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>Shutdown</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>GracefulStop</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>bufnet</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that we have included a call counter on the <code>AgendaServer</code>. This allows us to verify from the tests what methods have been called via the gRPC server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>Daily</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Day</span>) (<span style=color:#a6e22e>out</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Docket</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Calls</span>[<span style=color:#a6e22e>DailyRPC</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnDaily</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>Schedule</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>) (<span style=color:#a6e22e>out</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Calls</span>[<span style=color:#a6e22e>ScheduleRPC</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnSchedule</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The mock also gives us the ability to configure how the gRPC handlers will behave. For example, we might want to test how our code deals with errors or specific responses from the handlers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// UseFixture loads a a JSON fixture from disk (usually in a testdata folder) to use as
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the protocol buffer response to the specified RPC, simplifying handler mocking.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>UseFixture</span>(<span style=color:#a6e22e>rpc</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>path</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not read fixture: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>jsonpb</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>protojson</span>.<span style=color:#a6e22e>UnmarshalOptions</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>AllowPartial</span>:   <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>DiscardUnknown</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>rpc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ScheduleRPC</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jsonpb</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>out</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not unmarshal json into %T: %v&#34;</span>, <span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnSchedule</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>out</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DailyRPC</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Docket</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jsonpb</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>out</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not unmarshal json into %T: %v&#34;</span>, <span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnDaily</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Day</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Docket</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>out</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unknown RPC %q&#34;</span>, <span style=color:#a6e22e>rpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UseError allows you to specify a gRPC status error to return from the specified RPC.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AgendaServer</span>) <span style=color:#a6e22e>UseError</span>(<span style=color:#a6e22e>rpc</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Code</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>rpc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ScheduleRPC</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnSchedule</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Item</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DailyRPC</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>OnDaily</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Day</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Docket</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unknown RPC %q&#34;</span>, <span style=color:#a6e22e>rpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=putting-it-all-together>Putting It All Together</h2><p>With our mock package, writing gRPC tests becomes more of a matter of <em>what</em> we want to test rather than <em>how</em> to test it. The test below verifies that our mock works by simulting an error path and a &ldquo;happy&rdquo; path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSchedule</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Setup AgendaServer mock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>New</span>(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Shutdown</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a client to test that is connected to the mock server.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dialer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithContextDialer</span>(<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Channel</span>().<span style=color:#a6e22e>Dialer</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>creds</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithTransportCredentials</span>(<span style=color:#a6e22e>insecure</span>.<span style=color:#a6e22e>NewCredentials</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>agenda</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;bufconn&#34;</span>, <span style=color:#a6e22e>dialer</span>, <span style=color:#a6e22e>creds</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;could not connect to remote agenda via bufconn&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Test the case where the server returns an error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>UseError</span>(<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>ScheduleRPC</span>, <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>DataLoss</span>, <span style=color:#e6db74>&#34;something bad happened&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>agenda</span>.<span style=color:#a6e22e>Schedule</span>(<span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#e6db74>&#34;world&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;expected an error returned from the server&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Calls</span>[<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>ScheduleRPC</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Test the case where server returns a response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>UseFixture</span>(<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>ScheduleRPC</span>, <span style=color:#e6db74>&#34;testdata/item.json&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>agenda</span>.<span style=color:#a6e22e>Schedule</span>(<span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#e6db74>&#34;world&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;expected no error in happy path&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Calls</span>[<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>ScheduleRPC</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Mocking gRPC services for the purposes of testing isn&rsquo;t always straightforward. However, with tools like <code>bufconn</code> and some clever code factoring, we can create an in-memory mock that is completely isolated from production code. Introducing some measure of configurability into the mocks can also help us focus on <em>what</em> we&rsquo;re testing rather than <em>how</em> we&rsquo;re testing it.</p><p>Check out the full tutorial code <a href=https://github.com/rotationalio/agenda>here</a>.</p><hr><p>Photo by <a href="https://unsplash.com/@jjying?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">JJ Ying</a> on <a href="https://unsplash.com/s/photos/technology?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></p><hr><h4 id=references>References</h4><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://pkg.go.dev/google.golang.org/grpc/test/bufconn>bufconn</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div></div><div class="bg-[#E8EFF6] max-w-[800px] mx-auto mt-9 p-8 rounded-lg"><div class=text-center><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl"><b class=text-[#1D65A6]>About</b>
This Post</h3></div><p class="mt-4 text-base mx-auto text-center sm:mt-5 lg:mt-7 lg:text-base max-w-2xl">gRPC is a common framework used to facilitate communication between microservices, but testing these services can be a challenge. In this post we will present a simple strategy for mocking gRPC services in Go.</p><div class="md:flex text-center max-w-[600px] mx-auto border-t pt-6 mt-6 align-center justify-between"><div><div class="text-lg text-[#1D65A6] font-bold mb-3">Written by:</div><div class="flex items-center mt-4 mb-6"><img src=img/team/patrick-deziel.png alt class="border-4 border-white rounded-full h-11 drop-shadow-lg"><span class=ml-3>Patrick Deziel</span></div></div><div class="sm:ml-10 sm:mt-0 mt-12"><div class="text-lg text-[#1D65A6] font-bold mb-3">Share this post:</div><ul class="grid grid-cols-3 gap-6 mt-4"><li><a onclick=shareByEmail() class="flex items-center"><img src=img/email.png alt class="p-3 bg-white rounded-lg mr-3"></a></li><li><a onclick=shareOnTwitterWithTitle() class="flex items-center"><img src=img/twitter.png alt class="p-3 bg-white rounded-lg mr-4"></a></li><li><a onclick=shareOnLinkedIn() class="flex items-center"><img src=img/linkedin.png alt class="p-3 bg-white rounded-lg mr-3"></a></li></ul></div></div></div><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class="flex justify-between mt-12 sm:mt-24 items-center"><h2 class="font-bold text-2xl sm:text-4xl flex"><span><b class=text-[#1D65A6]>Recent</b>
Rotations</span>
<img src=img/butterfly.png alt=butterfly class="ml-4 h-6 sm:h-8 relative top-1"></h2><div><a href=/blog class="flex text-base sm:text-lg items-center font-bold text-[#1D65A6]"><span>View all</span>
<img src=img/arr-right.png alt class="h-4 ml-2"></a></div></div><div><div class="sm:grid grid-cols-3 gap-8 sm:mt-16"><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/prototyping-eda-with-watermill/><img src=https://rotational.io/img/blog/watermill.jpg alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><h4 class="text-base font-bold text-[#1D65A6]">Microservices, Eventing</h4><h3 class="text-xl font-extrabold mt-3"><a class="block h-24" href=https://rotational.io/blog/prototyping-eda-with-watermill/>Prototyping Event-Driven Applications With Watermill</a></h3><div class=art-s><p class="mt-3 text-base font-extralight"><p>Event-driven architectures (EDA) are <a href=https://rotational.io/blog/five-technologies-quietly-transforming-the-web/>enjoying a resurgence in interest</a> due to many organizations&rsquo; need to accelerate rapid prototyping and get by with smaller, more cross-functional teams. In this post, we&rsquo;ll demonstrate how to …</p></p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><img src=img/team/prema-roman.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Prema Roman</span></div><div class=font-extralight>Jan 21, 2023</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/building-a-raft-part-2/><img src=https://rotational.io/img/blog/2023-01-10-building-a-raft-part-2/otterRaftTwo.png alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><h4 class="text-base font-bold text-[#1D65A6]">Distributed Systems</h4><h3 class="text-xl font-extrabold mt-3"><a class="block h-24" href=https://rotational.io/blog/building-a-raft-part-2/>Building a Raft (Part 2)</a></h3><div class=art-s><p class="mt-3 text-base font-extralight"><p>In our first installment on how to implement the famous Raft algorithm, we introduced the log: an ordered sequence of operations that serves as the core data structure for distributed consensus. In this second part, we&rsquo;ll demonstrate …</p></p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><img src=img/team/daniel-sollis.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Daniel Sollis</span></div><div class=font-extralight>Jan 10, 2023</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/disrupt-managed-services/><img src=https://rotational.io/img/blog/dandelion.jpg alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><h4 class="text-base font-bold text-[#1D65A6]">Managed Services</h4><h3 class="text-xl font-extrabold mt-3"><a class="block h-24" href=https://rotational.io/blog/disrupt-managed-services/>3 Trends that Will Disrupt Managed Services in 2023</a></h3><div class=art-s><p class="mt-3 text-base font-extralight"><p>If nothing else, the last year has brought the winds of change to the tech sector. From high-visibility <a href=https://layoffs.fyi/>layoff cycles</a> at FAANGs and crypto companies, to turbulence in our <a href=https://rotational.io/blog/twitter-wont-disappear-overnight/>social media infrastructure</a>, to pop culture&rsquo;s discovery of deep …</p></p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><img src=img/team/rebecca-bilbro.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Rebecca Bilbro</span></div><div class=font-extralight>Dec 23, 2022</div></div></div></div></div></div></div></div></div><div class="bg-[#1D65A6] max-w-[800px] mx-auto mt-20 py-14 px-12 md:px-16 text-white md:rounded-lg"><form action=blog method=post id=newsletterForm><h6 class="font-bold text-center">Enter Your Email To Subscribe</h6><label for=email class=hidden>Email</label>
<input type=text name=email id=email required placeholder class="w-full px-4 py-2.5 rounded-lg mt-6 text-black" style=color:#000><div class="flex mt-6 items-start"><input type=checkbox id=checkbox required class="w-6 h-6 block border-0">
<label for=checkbox><span class="ml-2 text-left">I want to receive the monthly newsletter and other updates from Rotational. You agree to our Privacy Policy. You may unsubscribe at any time.*</span></label></div><div class="bg-teal-100 border-t-4 border-teal-500 mt-10 rounded-b text-teal-900 px-4 py-3 shadow-md hidden" id=newsletter-alert role=alert><div class=flex><div><p class=text-sm>Thank you for your interest!</p></div></div></div><div class="flex justify-center"><button type=submit class="bg-[#192E5B] px-14 py-4 mt-10 rounded-lg text-sm text-white uppercase md:text-base">
Submit</button></div></form></div></main><div id=footerBackground><footer class="bg-hero-footer bg-cover"><div class="relative pt-[350px] font-extralight"><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class="lg:grid grid-cols-3 text-white"><div><a href=/><img src=img/logo-white.png alt="Rotational Labs logo" class="mt-10 sm:mt-0 mx-auto sm:pb-5"></a></div><div class="mx-auto mt-5 sm:mt-0 max-w-lg pb-8 xl:mr-5"><h5 class="text-center lg:text-start font-bold text-lg">Contact Details</h5><p class="mt-3 ml-10 sm:ml-0 text-lg">We love to talk through complex scaling and performance issues. What’s slowing you down? Drop us a line for a friendly chat. We’ll make it worth your while.</p></div><div class="ml-10 xl:ml-5 sm:mt-0 mt-8"><ul class="sm:grid grid-cols-2 lg:flex flex-col gap-0 mr-5 xl:grid gap-x-32 gap-y-4"><li class=pb-8><a href=mailto:info@rotational.io class="flex items-center" target=_blank><img src=img/email.png alt class="p-4 bg-white rounded-lg mr-4">
<span>info@rotational.io</span></a></li><li class=pb-8><a href=https://github.com/rotationalio class="flex items-center" target=_blank><img src=img/github.png alt class="p-4 bg-white rounded-lg mr-4">
<span>rotationalio</span></a></li><li class=pb-8><a href=https://twitter.com/rotationalio class="flex items-center" target=_blank><img src=img/twitter.png alt class="p-4 bg-white rounded-lg mr-4">
<span>@rotationalio</span></a></li><li class=pb-8><a href=https://www.linkedin.com/company/rotational class="flex items-center" target=_blank><img src=img/linkedin.png alt class="p-4 bg-white rounded-lg mr-4">
<span>Rotational</span></a></li></ul></div></div><div class="sm:flex justify-between border-t py-6 text-white mt-12 sm:mt-32"><p>Copyright © 2023 Rotational Labs, Inc · All Rights Reserved</p><ul class="sm:mt-0 mt-4 flex"><li class="border-r pr-4 mr-4"><a href=/privacy/>Privacy Policy</a></li><li><a href=/terms/>Terms of Use</a></li></ul></div></div></div></footer></div><script src=https://rotational.io/js/app.js></script></body></html>