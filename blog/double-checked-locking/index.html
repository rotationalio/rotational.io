<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Rotational Labs | Double-Checked Locking</title><base href=https://rotational.io/ target=_self><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Rotational Labs, Inc."><meta name=description content="Double-checked locking is a common mechanism to avoid race conditions when using read and write locks. This is the first in a series of posts about concurrency patterns in Go!"><meta name=keywords content="Rotational Labs,Ensign,Cloud-native,Real-time data streaming platform,Data collaboration,Data automation,Rapid prototyping,Real-time machine learning,Real-time data analytics,Real-time applications,Data streams,Event streams,Event-sourcing databaseEvent log"><link type=text/plain rel=author href=https://rotational.io/humans.txt><meta property="og:title" content="Double-Checked Locking"><meta property="og:description" content="Double-checked locking is a common mechanism to avoid race conditions when using read and write locks. This is the first in a series of posts about concurrency patterns in Go!"><meta property="og:image" content="https://rotational.io/img/blog/clover-blanket.jpg"><meta property="og:url" content="https://rotational.io/blog/double-checked-locking/"><meta property="og:type" content="website"><meta name=twitter:title content="Double-Checked Locking"><meta name=twitter:card content="summary"><meta name=twitter:description content="Double-checked locking is a common mechanism to avoid race conditions when using read and write locks. This is the first in a series of posts about concurrency patterns in Go!"><meta name=twitter:image content="https://rotational.io/img/blog/clover-blanket.jpg"><link rel="shortcut icon" href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/img/favicon.png type=image/x-icon><link rel=alternate type=application/rss+xml href=https://rotational.io//index.xml title="Recent Rotations of the Rotational Labs Blog"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.css><link rel=stylesheet href=https://unpkg.com/@highlightjs/cdn-assets/styles/default.min.css><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel=stylesheet><link rel=stylesheet href=https://rotational.io/output.css media=screen><script async src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2FKX6CWJHW")</script><script src="https://www.google.com/recaptcha/enterprise.js?render=6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk"></script>
<script>grecaptcha.enterprise.ready(function(){grecaptcha.enterprise.execute("6Ld5O3kiAAAAAJU0z0h81X1RxEMHyoROe6KWe_vk",{action:"homepage"}).then(function(){})})</script><script src=https://kit.fontawesome.com/2c36e9b7b1.js crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr/lunr.js></script></head><body class="bg-hexagon bg-center bg-contain"><div class="relative bg-[#1D65A6]"><nav class="relative max-w-7xl mx-auto flex items-center justify-between text-white px-4 sm:px-6 z-[9999] py-5" aria-label=Global><a href=/><img src=img/logo.png alt="Rotational Lab logo" class="h-14 w-auto sm:h-14"></a><div class=topnav id=myTopnav><a href=/ensign/>Ensign</a>
<a href=/services/>Services</a>
<a href=/blog/>Blog</a>
<a href=/about/>About</a>
<a href=/contact/>Request a Demo</a>
<a href=https://rotational.app/register>Get Ensign Free</a>
<a class=icon onclick=openMobNav()><i class="fa fa-bars"></i></a></div></nav></div><main><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class=mt-14><div class=blog-img><img src=https://rotational.io/img/blog/clover-blanket.jpg alt="Double-Checked Locking" class="mx-auto object-cover"></div><div class=mt-8><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center" data-blog-title="Double-Checked Locking"><b class=text-[#1D65A6]>Double-Checked</b>
Locking</h3><div class="flex flex-wrap justify-center items-center my-4"><img src=img/butterfly.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg">
<span class=blog-date><a href=/authors/benjamin-bengfort class=single-multi-author>Benjamin Bengfort</a>
<span class=blog-date><a href=/authors/prema-roman class=single-multi-author>Prema Roman</a> | Friday, Mar 17, 2023 |&nbsp;</span>
<span><a href=/tags/concurrency class=blog-tag>Concurrency</a></span></div><article class="max-w-[800px] mx-auto prose"><p>Double-checked locking is a common mechanism to avoid race conditions when using read and write locks. Unfortunately, as with nearly all things related to concurrency, it is easy to get wrong or forget.</p><p><strong>tl;dr</strong> If you&rsquo;re just looking for an example in Go of double-checked locking, an example is below. Please note however that double-checked locking is not good for <strong>all</strong> systems and is sometimes <a href=https://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html>considered an anti-pattern</a>. Using other Go concurrency mechanisms like <a href=https://pkg.go.dev/sync#Once><code>sync.Once</code></a> can be a better choice, e.g. for Singleton design patterns.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Store</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>values</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>Limiter</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Store</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>client</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>limiter</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>Limiter</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// To prevent contention we want to use the RLock as much as possible.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// First check if the rate limiter exists for the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>exists</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>limiter</span>, <span style=color:#a6e22e>exists</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>client</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We need to obtain a write lock in order to create a limiter for the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// However, we need to unlock the read lock first to prevent a deadlock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Because another go routine could have acquired the lock between when we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// unlocked the read lock and acquired the write lock, we have to double check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// our condition or risk overwriting the limiter that is already created.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>limiter</span>, <span style=color:#a6e22e>exists</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>client</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>limiter</span> = <span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>NewLimiter</span>(<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>120</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>client</span>] = <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Unlock the write lock and return the limiter. Note we need to return in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// if block at this point to prevent a second call to s.RUnlock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For more on the reasoning behind double-checked locking; read on!</p><h2 id=introduction>Introduction</h2><p>This is the first part in a series of posts about concurrency patterns in Go and like all good series, it comes from our real life experience of working on highly concurrent distributed systems like <a href=https://rotational.io/ensign/>Ensign</a>!</p><p>Consider the scenario where you would like a data structure to be synchronized between many go routines such that if a value does not exist in the data structure a go routine can add the value, but the value should not be overridden by other go routines. A good example of this is a cache, where you would like to store a value used by other go routines for a set amount of time before deleting it to prevent unbounded memory growth.</p><p>At the end of this post, we&rsquo;ll show you our real world example that we created for rate limiting, but to illustrate the problem, let&rsquo;s look at a simple example first.</p><h2 id=the-problem>The Problem</h2><p>Consider the following <code>Store</code>, where we&rsquo;d like to have go routines concurrently access values in a <code>map</code> that is rarely written to. In particular, the value of the map will only be set once if it does not exist, read a lot, then potentially deleted in the future.</p><p>Because most of our accesses are reads, using a <code>sync.Mutex</code> seems very heavy weight; it only allows one go routine access to the map at a time, no matter what key they are accessing. This could really slow down the performance of our program. To allow concurrent read access to the map we implement a <code>sync.RWMutex</code> as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Store</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>values</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SetOnce sets the value to the key only if it doesn&#39;t already have a value. Returns
</span></span></span><span style=display:flex><span><span style=color:#75715e>// true if the value was set (e.g. it did not exist already).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Store</span>) <span style=color:#a6e22e>SetOnce</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>key</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Store</span>) <span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Sidenote</strong>: if the above is your usecase, consider using a <a href=https://pkg.go.dev/sync#Map><code>sync.Map</code></a> instead. However as the documentation suggests, depending on your access pattern, implementing double-checked locking <em>might</em> be better.</p><p>Unfortunately, the above implementation introduces a race condition. It is possible for two or more go routines to perform the check in the read-lock concurrently, detect that the value does not exist, then attempt to acquire the write lock. Go queues accessors to the write lock, therefore they will each acquire it one at a time, write their value and overwite the previous value set by the go routine.</p><p>Try running the <a href=https://go.dev/play/p/vDwbAg64Yj4>following example code on the Go playground</a> a few times; you&rsquo;ll notice that occasionally you&rsquo;ll have two or more go routines who think they&rsquo;ve set the value. If you don&rsquo;t see it the first time, keep trying. You will notice that at least one of the tests has a situation where the value gets set more than once. See the screenshot below for an example. One of the reasons this error is so common is because the race condition is very hard to observe! To more clearly illustrate the point, you can also introduce some lag in the <code>set</code> function either by doing a computation before acquiring the lock or sleeping for a bit of time.</p><p><img src=/img/blog/2023-03-17-double-checked-locking/race_condition.png alt="&ldquo;Race Condition&rdquo;"></p><h2 id=the-solution>The Solution</h2><p>To prevent the race from occurring, we want to ensure that <em>only</em> the first go routine to acquire the lock sets it. To do this, we need to double-check our initial existence condition to make sure it&rsquo;s still true when we&rsquo;ve acquired the write lock.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// SetOnce sets the value to the key only if it doesn&#39;t already have a value. Returns
</span></span></span><span style=display:flex><span><span style=color:#75715e>// true if the value was set (e.g. it did not exist already).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Store</span>) <span style=color:#a6e22e>SetOnce</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Acquire the read lock and check if the value exists
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>key</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Acquire a write lock to set the value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Double-check that the condition isn&#39;t true and some other go routine didn&#39;t
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// beat the caller to acquiring the write lock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>key</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>values</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Otherwise, don&#39;t overwrite the old value, but also make sure to return so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// that we don&#39;t call s.RUnlock twice accidentally in this function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now you&rsquo;re guaranteed that only one go routine will ever set the value. Note, however, that you can&rsquo;t guarantee <em>which</em> go routine sets the value, just that whichever go routine acquires the write lock first will be the winner.</p><p>Here is <a href=https://go.dev/play/p/KuI2bL6o0tb>example code on the Go playground</a> that illustrates the semantic. Run the test multiple times and you will notice that the value gets set only once per test.</p><h2 id=rate-limiter-example>Rate Limiter Example</h2><p>We have an API service that we want to prevent from being abused, so we&rsquo;d like to rate limit it on a per-client basis. However, we also expect that we&rsquo;ll have lots of clients, so we don&rsquo;t want to store rate limit information for the duration of the service and we&rsquo;d like to clean it up occasionally!</p><p>Determining if a client is violating rate limits can be done using the Golang <a href=https://pkg.go.dev/golang.org/x/time/rate>rate</a> package. However, we need some data structure to map clients by their ID or IP address to their specific limiter. Each request is handled by the API server in its own Go routine and we have another go routine that is routinely cleaning up all of our rate limiters to prevent unbounded growth.</p><p>Below is a <em>much simplified</em> version of our limiter solution (don&rsquo;t directly copy and paste this code, it is for illustration purposes; but if you&rsquo;re interested in a blog post about rate limiting, let us know!)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientLimiter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clients</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>Limiter</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>limit</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>burst</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClientLimiter</span>(<span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>burst</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>cleanupInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientLimiter</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>limiter</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientLimiter</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>clients</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>Limiter</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>limit</span>: <span style=color:#a6e22e>limit</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>burst</span>: <span style=color:#a6e22e>burst</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start the limiter cleanup go routine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>cleanup</span>(<span style=color:#a6e22e>cleanupInterval</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get or create a rate limiter for the specified client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientLimiter</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>client</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>limiter</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>Limiter</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>exists</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>limiter</span>, <span style=color:#a6e22e>exists</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>clients</span>[<span style=color:#a6e22e>client</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create the limiter with double-checked locking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>limiter</span>, <span style=color:#a6e22e>exists</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>clients</span>[<span style=color:#a6e22e>client</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>limiter</span> = <span style=color:#a6e22e>rate</span>.<span style=color:#a6e22e>NewLimiter</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>burst</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>clients</span>[<span style=color:#a6e22e>client</span>] = <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>limiter</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Check if the client is allowed access, if false they&#39;ve exceeded the rate limit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientLimiter</span>) <span style=color:#a6e22e>Allow</span>(<span style=color:#a6e22e>client</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>client</span>).<span style=color:#a6e22e>Allow</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Periodically cleanup the limiters in the client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientLimiter</span>) <span style=color:#a6e22e>cleanup</span>(<span style=color:#a6e22e>interval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>interval</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// NOTE: you probably want to do more here e.g. select on a stop channel or
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// grab the timestamp from the ticker to remove limiters that haven&#39;t been used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// in a certain amount of time. This simplified implementation is brute force.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// double-checked locking, acquiring a lock for only one key at a time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>clients</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>clients</span>[<span style=color:#a6e22e>client</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>                delete(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>clients</span>[<span style=color:#a6e22e>client</span>])
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Hopefully this real world example illustrates why double-checked locking might be a good concurrency pattern in some multi-threaded environments.</p><p>We&rsquo;re looking to create a series on concurrency design patterns; stay tuned to the blog for more to come in the series!</p></article></div></div><div class="bg-[#E8EFF6] max-w-[800px] mx-auto mt-9 p-8 rounded-lg"><h3 class="font-bold text-xl sm:text-2xl lg:text-3xl text-center mb-3"><span class="text-[#1D65A6] font-bold">About</span>
This Post</h3><p class="text-base mx-auto px-2 text-center lg:text-base">Double-checked locking is a common mechanism to avoid race conditions when using read and write locks. This is the first in a series of posts about concurrency patterns in Go!</p><div class="flex flex-col md:flex-row text-center mx-auto border-t pt-6 mt-6 align-center justify-between gap-10"><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Written by:</h2><div class="flex items-center"><img src=img/butterfly.png alt class="mr-3 border-4 border-white rounded-full h-11 drop-shadow-lg">
<span class="flex flex-wrap"><a href=/authors/benjamin-bengfort class="single-multi-author lg:w-[20ch] mx-2">Benjamin Bengfort</a>
<span class="flex flex-wrap"><a href=/authors/prema-roman class="single-multi-author lg:w-[20ch] mx-2">Prema Roman</a></span></div></div><div class=lg:w-1/2><h2 class="text-lg text-[#1D65A6] font-bold mb-3">Share this post:</h2><ul class="flex items-center justify-center gap-6 mt-4"><li><a onclick=shareByEmail() class=cursor-pointer><img src=img/email.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnTwitterWithTitle() class=cursor-pointer><img src=img/twitter.png alt class="rounded-lg bg-white p-3"></a></li><li><a onclick=shareOnLinkedIn() class=cursor-pointer><img src=img/linkedin.png alt class="rounded-lg bg-white p-3"></a></li></ul></div></div></div><div class="relative max-w-7xl mx-auto px-4 sm:px-6"><div class="flex justify-between mt-12 sm:mt-24 items-center"><h2 class="font-bold text-2xl sm:text-4xl flex"><span><b class=text-[#1D65A6]>Recent</b>
Rotations</span>
<img src=img/butterfly.png alt=butterfly class="ml-4 h-6 sm:h-8 relative top-1"></h2><div><a href=/blog class="flex text-base sm:text-lg items-center font-bold text-[#1D65A6]"><span>View all</span>
<img src=img/arr-right.png alt class="h-4 ml-2"></a></div></div><div><div class="grid md:grid-cols-2 xl:grid-cols-3 gap-8 sm:mt-16"><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/pubsub-101---querying-topics/><img src=https://rotational.io/img/blog/otter_investigator.png alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex whitespace-nowrap"><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/ensign>Ensign</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/ensql>enSQL</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/pubsub-101>PubSub 101</a></li></ul><h3 class="text-xl font-extrabold mt-3 pb-2"><a class="block h-24" href=https://rotational.io/blog/pubsub-101---querying-topics/>PubSub 101 - Querying Topics with SQL</a></h3><div class=h-36><p class="mt-8 text-base">Real-time data streams are powerful, but sometimes you need to convert the stream into a batch or replay parts of the stream. Here&rsquo;s how to write customized SQL to more deeply understand and interact with your historic data.</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><a href=/authors/patrick-deziel class="flex items-center"><img src=img/team/patrick-deziel.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Patrick Deziel</span></a></div><div class=font-extralight>Dec 8, 2023</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/pubsub-101---creating-a-subscriber/><img src=https://rotational.io/img/blog/newspaper.jpg alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex whitespace-nowrap"><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/ensign>Ensign</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/online-learning>Online Learning</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/pubsub-101>PubSub 101</a></li></ul><h3 class="text-xl font-extrabold mt-3 pb-2"><a class="block h-24" href=https://rotational.io/blog/pubsub-101---creating-a-subscriber/>PubSub 101 - Creating a Subscriber</a></h3><div class=h-36><p class="mt-8 text-base">With the rise of LLMs and Retrieval Augmented Generation (RAG), online models have never been more relevant. Here&rsquo;s how to write some Python code to interpret real-time data and build your own adaptive online model.</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><a href=/authors/patrick-deziel class="flex items-center"><img src=img/team/patrick-deziel.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Patrick Deziel</span></a></div><div class=font-extralight>Dec 5, 2023</div></div></div></div></div><div class=mt-6><div class=article><a class=block href=https://rotational.io/blog/pubsub-101---creating-a-publisher/><img src=https://rotational.io/img/blog/press.jpg alt class="rounded-t-xl object-cover" style=height:212px;width:100%></a><div class="bg-[#ECF6FF] rounded-b-xl"><div class="px-6 pt-4"><ul class="flex whitespace-nowrap"><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/ensign>Ensign</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/ingestion>Ingestion</a></li><li class="blog-tag text-base font-bold text-[#1D65A6]"><a href=/tags/pubsub-101>PubSub 101</a></li></ul><h3 class="text-xl font-extrabold mt-3 pb-2"><a class="block h-24" href=https://rotational.io/blog/pubsub-101---creating-a-publisher/>PubSub 101 - Creating a Publisher</a></h3><div class=h-36><p class="mt-8 text-base">One of the first steps in every data science or machine learning project is data ingestion. In this module, you will use Python to create a publisher to ingest real-time data into Ensign.</p></div></div><div class="flex justify-between items-center px-6 py-3 border-t mt-6"><div class="flex items-center"><a href=/authors/patrick-deziel class="flex items-center"><img src=img/team/patrick-deziel.png alt class="rounded-full h-10 w-10">
<span class="ml-4 font-extralight">Patrick Deziel</span></a></div><div class=font-extralight>Nov 28, 2023</div></div></div></div></div></div></div></div></div><div class="bg-[#1D65A6] max-w-[800px] mx-auto mt-20 py-14 px-12 md:px-16 text-white md:rounded-lg"><form action=blog method=post id=newsletterForm><h6 class="font-bold text-center">Enter Your Email To Subscribe</h6><label for=email class=hidden>Email</label>
<input type=text name=email id=email required placeholder class="w-full px-4 py-2.5 rounded-lg mt-6 text-black" style=color:#000><div class="flex mt-6 items-start"><input type=checkbox id=checkbox required class="w-6 h-6 block border-0">
<label for=checkbox><span class="ml-2 text-left">I want to receive the monthly newsletter and other updates from Rotational. You agree to our Privacy Policy. You may unsubscribe at any time.*</span></label></div><div class="bg-teal-100 border-t-4 border-teal-500 mt-10 rounded-b text-teal-900 px-4 py-3 shadow-md hidden" id=newsletter-alert role=alert><div class=flex><div><p class=text-sm>Thank you for your interest!</p></div></div></div><div class="flex justify-center"><button type=submit class="bg-[#192E5B] px-14 py-4 mt-10 rounded-lg text-sm text-white uppercase md:text-base">
Submit</button></div></form></div></main><div id=footerBackground><footer class="bg-hero-footer bg-cover"><div class="pt-[350px] font-extralight text-white"><div class="max-w-7xl mx-auto px-6"><div class="max-[650px]:text-center sm:grid grid-cols-3"><div class="my-10 sm:my-0"><h5 class=mb-3>PRODUCT</h5><ul><li class=pb-3><a href=https://rotational.app target=_blank class=font-bold>Ensign</a></li><li class=pb-3><a href=/ensign-pricing target=_blank class=font-bold>Pricing</a></li><li class=pb-3><a href=https://ensign.rotational.dev/getting-started/ target=_blank class=font-bold>Docs</a></li><li class=pb-3><a href=https://ensign.rotational.dev/sdk/ target=_blank class=font-bold>SDKs</a></li><li class=pb-3><a href=https://status.rotational.dev/ target=_blank class=font-bold>Status</a></li></ul></div><div class="mb-10 sm:mb-0"><h5 class=mb-3>COMPANY</h5><ul><li class=pb-3><a href=/services class=font-bold>Services</a></li><li class=pb-3><a href=/blog class=font-bold>Blog</a></li><li class=pb-3><a href=/about class=font-bold>About</a></li></ul></div><div><h5 class=mb-3>COMMUNITY</h5><ul><li class=pb-3><a href=/ensign-u class=font-bold>Ensign U</a></li><li class=pb-3><a href=/data-playground class=font-bold>Data Playground</a></li><li class=pb-3><a href=/opensource class=font-bold>Open Source</a></li><li class=pb-3><a href=/resources class=font-bold>Resources</a></li></ul></div></div><div class="max-w-7xl sm:flex justify-between border-t py-6 mt-12 sm:mt-32"><div class="mx-auto xl:ml-5 sm:mt-0 mt-8"><div><ul class="mx-auto grid grid-cols-2 gap-x-20 md:gap-x-32 lg:grid-cols-4"><li class="pb-8 mt-1"><a href=https://twitter.com/rotationalio class="flex items-center p-2 hover:rounded-full hover:bg-icon-hover" target=_blank><img src=img/footer/twitter.svg alt class=scale-75>
<span class=ml-4>Twitter</span></a></li><li class="pb-8 mt-1"><a href=https://github.com/rotationalio class="flex items-center p-2 hover:rounded-full hover:bg-icon-hover" target=_blank><img src=img/footer/github.svg alt class=scale-[.8]>
<span class=ml-4>GitHub</span></a></li><li class=pb-8><a href=https://www.linkedin.com/company/rotational class="flex items-center p-2 hover:rounded-full hover:bg-icon-hover" target=_blank><img src=img/footer/linkedin.svg alt class=scale-75>
<span class="mt-2 ml-4">LinkedIn</span></a></li><li class="pb-8 mt-2"><a href=mailto:info@rotational.io class="flex items-center p-2 hover:rounded-full hover:bg-icon-hover" target=_blank><img src=img/footer/email.svg alt class=scale-[.8]>
<span class=ml-4>Email</span></a></li></ul></div></div></div><div class="sm:flex justify-between py-6"><p>Copyright © Rotational Labs, Inc. 2021–2023 · All Rights Reserved</p><div><ul class="sm:mt-0 mt-4 flex"><li class="border-r pr-4 mr-4"><a href=/privacy/>Privacy Policy</a></li><li><a href=/terms/>Terms of Use</a></li></ul></div></div></div></div></div></footer></div><script src=https://rotational.io/js/app.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js></script>
<script src=https://unpkg.com/@highlightjs/cdn-assets/highlight.min.js></script></body></html>