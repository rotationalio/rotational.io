<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Marshaling Go Enums to and from JSON</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="How to customize JSON serialization for your data types while avoiding pointer and receiver problems -- a story in three parts."><meta name=author content="Rotational Labs, LLC"><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=https://rotational.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://rotational.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://rotational.io/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://rotational.io/plugins/slick/slick.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Anaheim%7cQuattrocento+Sans:400,700&display=swap"><link rel=stylesheet href=https://rotational.io/css/style.min.css media=screen><link rel=stylesheet href=https://rotational.io/css/custom.min.css media=screen><link rel="shortcut icon" href=https://rotational.io/images/assets/icons/favicon.png type=image/x-icon><link rel=icon href=https://rotational.io/images/assets/icons/favicon.png type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-2FKX6CWJHW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-2FKX6CWJHW')</script></head><body id=body data-spy=scroll data-target=.navbar data-offset=55><div id=content><section class="sticky-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-dark"><a class="navbar-brand p-0" href=/><img class=lozad data-src=https://rotational.io/images/assets/logos/logo.png alt="Rotational Labs" height=57></a>
<button class="navbar-toggler rounded-0" type=button data-toggle=collapse data-target=#navigation>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://rotational.io/#about>about</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#services>services</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#team>team</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/blog>blog</a></li><li class=nav-item><a class=nav-link href=https://rotational.io/#contact>contact</a></li></ul><select id=select-language onchange="location=this.value"><option id=en value=https://rotational.io/blog/marshaling-go-enums-to-and-from-json/ selected>En</option></select></div></nav></div></section><section class=section><div class=container><div class=row><div class="col-lg-8 offset-lg-2 text-center"><h1>Marshaling Go Enums to and from JSON</h1><ul class="list-inline mb-50"><li class=list-inline-item><a href=/author/benjamin-bengfort/>Benjamin Bengfort</a></li><li class=list-inline-item>Thursday, May 26, 2022</li></ul><img class="img-fluid mb-50 lozad" data-src=https://rotational.io/images/blog/fireworks_star.jpg alt=blog-image></div><div class="col-lg-8 offset-lg-2"><div class=post-single-content><p>Customizing JSON serialization for your data types seems relatively straightforward on the surface, but it&rsquo;s easy to get turned around in receiver, value, pointer, and indirection confusion. Many of the patterns and rules-of-thumb you use in your normal Go code can lead you astray. In this post, we&rsquo;ll illustrate exactly how and why to handle these edge cases.</p><p>But before we get any further, if you&rsquo;re using this as a reference to determine how to implement JSON serialization for an enum type, here is the code snippet you&rsquo;re looking for:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>type</span> Suit <span style=color:#6ab825;font-weight:700>uint8</span>

<span style=color:#999;font-style:italic>// MarshalJSON must be a *value receiver* to ensure that a Suit on a parent object
</span><span style=color:#999;font-style:italic>// does not have to be a pointer in order to have it correctly marshaled.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s Suit) <span style=color:#447fcf>MarshalJSON</span>() ([]<span style=color:#6ab825;font-weight:700>byte</span>, <span style=color:#6ab825;font-weight:700>error</span>) {
    <span style=color:#999;font-style:italic>// It is assumed Suit implements fmt.Stringer.
</span><span style=color:#999;font-style:italic></span>    <span style=color:#6ab825;font-weight:700>return</span> json.<span style=color:#447fcf>Marshal</span>(s.<span style=color:#447fcf>String</span>())
}

<span style=color:#999;font-style:italic>// UnmarshalJSON must be a *pointer receiver* to ensure that the indirect from the
</span><span style=color:#999;font-style:italic>// parsed value can be set on the unmarshaling object. This means that the
</span><span style=color:#999;font-style:italic>// ParseSuit function must return a *value* and not a pointer.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s *Suit) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
    <span style=color:#6ab825;font-weight:700>var</span> suits <span style=color:#6ab825;font-weight:700>string</span>
    <span style=color:#6ab825;font-weight:700>if</span> err := json.<span style=color:#447fcf>Unmarshal</span>(data, &amp;suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
        <span style=color:#6ab825;font-weight:700>return</span> err
    }
    <span style=color:#6ab825;font-weight:700>if</span> *s, err = <span style=color:#447fcf>ParseSuit</span>(suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
        <span style=color:#6ab825;font-weight:700>return</span> err
    }
    <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>The complete, interactive, and runable code can be found <a href=https://go.dev/play/p/oMh1TDiwi_H>on the Go playground</a>.</p><h2 id=customizing-json-serialization-in-go>Customizing JSON Serialization in Go</h2><p>The German-American side of my family loves playing <a href=https://bicyclecards.com/how-to-play/euchre/>Euchre</a>, so I thought it might be an interesting idea to create an online multiplayer card game to stay connected during the pandemic. To describe decks and hands, I had to define cards, and in order to define cards, I had to implement a <code>Suit</code> type to describe the four possible card suits: hearts, diamonds, clubs, and spades. An <a href=https://en.wikipedia.org/wiki/Enumerated_type>Enum (short for enumerated type)</a> is an excellent choice to define suits, and in fact &ndash; the Wikipedia article about enumerated types uses card suits as an example!</p><p>Here is a classic definition of an enum in Go using <a href=https://www.gopherguides.com/articles/how-to-use-iota-in-golang><code>iota</code></a> to declare constant uint8 for our suits.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>const</span> (
	Hearts Suit = <span style=color:#6ab825;font-weight:700>iota</span> + <span style=color:#3677a9>1</span>
	Diamonds
	Clubs
	Spades
)

<span style=color:#6ab825;font-weight:700>type</span> Suit <span style=color:#6ab825;font-weight:700>uint8</span>

<span style=color:#6ab825;font-weight:700>var</span> (
	Suit_name = <span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>uint8</span>]<span style=color:#6ab825;font-weight:700>string</span>{
		<span style=color:#3677a9>1</span>: <span style=color:#ed9d13>&#34;♥&#34;</span>,
		<span style=color:#3677a9>2</span>: <span style=color:#ed9d13>&#34;♦&#34;</span>,
		<span style=color:#3677a9>3</span>: <span style=color:#ed9d13>&#34;♣&#34;</span>,
		<span style=color:#3677a9>4</span>: <span style=color:#ed9d13>&#34;♠&#34;</span>,
	}
	Suit_value = <span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>string</span>]<span style=color:#6ab825;font-weight:700>uint8</span>{
		<span style=color:#ed9d13>&#34;♥&#34;</span>:        <span style=color:#3677a9>1</span>,
		<span style=color:#ed9d13>&#34;hearts&#34;</span>:   <span style=color:#3677a9>1</span>,
		<span style=color:#ed9d13>&#34;♦&#34;</span>:        <span style=color:#3677a9>2</span>,
		<span style=color:#ed9d13>&#34;diamonds&#34;</span>: <span style=color:#3677a9>2</span>,
		<span style=color:#ed9d13>&#34;♣&#34;</span>:        <span style=color:#3677a9>3</span>,
		<span style=color:#ed9d13>&#34;clubs&#34;</span>:    <span style=color:#3677a9>3</span>,
		<span style=color:#ed9d13>&#34;♠&#34;</span>:        <span style=color:#3677a9>4</span>,
		<span style=color:#ed9d13>&#34;spades&#34;</span>:   <span style=color:#3677a9>4</span>,
	}
)

<span style=color:#999;font-style:italic>// String allows Suit to implement fmt.Stringer
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> (s Suit) <span style=color:#447fcf>String</span>() <span style=color:#6ab825;font-weight:700>string</span> {
	<span style=color:#6ab825;font-weight:700>return</span> Suit_name[<span style=color:#24909d>uint8</span>(s)]
}

<span style=color:#999;font-style:italic>// Convert a string to a Suit, returns an error if the string is unknown.
</span><span style=color:#999;font-style:italic>// NOTE: for JSON marshaling this must return a Suit value not a pointer, which is
</span><span style=color:#999;font-style:italic>// common when using integer enumerations (or any primitive type alias).
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>ParseSuit</span>(s <span style=color:#6ab825;font-weight:700>string</span>) (Suit, <span style=color:#6ab825;font-weight:700>error</span>) {
	s = strings.<span style=color:#447fcf>TrimSpace</span>(strings.<span style=color:#447fcf>ToLower</span>(s))
	value, ok := Suit_value[s]
	<span style=color:#6ab825;font-weight:700>if</span> !ok {
		<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#447fcf>Suit</span>(<span style=color:#3677a9>0</span>), fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;%q is not a valid card suit&#34;</span>, s)
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#447fcf>Suit</span>(value), <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>The <code>Suit</code> enum uses 1 byte (a <code>uint8</code>) to define our constants in a small but still convenient package (technically all we need is 2 bits to represent our 4 values; a uint8 can represent up to 255 values but is far easier to work with). This is more compact than a string, but is not terribly human-friendly (e.g. you don&rsquo;t want to have to remember that <code>Hearts == 1</code>) so we implement the <a href=https://pkg.go.dev/fmt#Stringer><code>fmt.Stringer</code></a> interface so that we can print the suit as ♥, ♦, ♣, or ♠ and a <code>ParseSuit</code> function so we can easily convert a string to a <code>Suit</code>. We then get the best of both worlds: a compact enum that can be typechecked by the compiler and a string representation that we can read and understand.</p><p>All is well and we can implement our <code>Card</code> type:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>type</span> Card <span style=color:#6ab825;font-weight:700>struct</span> {
	Value <span style=color:#6ab825;font-weight:700>uint8</span> <span style=color:#ed9d13>`json:&#34;value&#34;`</span>
	Suit  Suit  <span style=color:#ed9d13>`json:&#34;suit&#34;`</span>
}
</code></pre></div><p>But when we attempt to marshal our card as JSON:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>card := &amp;Card{Value: <span style=color:#3677a9>7</span>, Suit: Spades}
data, _ := json.<span style=color:#447fcf>Marshal</span>(card)
fmt.<span style=color:#447fcf>Println</span>(<span style=color:#24909d>string</span>(data))
</code></pre></div><p>We get the following result:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#6ab825;font-weight:700>&#34;value&#34;</span>:<span style=color:#3677a9>7</span>,<span style=color:#6ab825;font-weight:700>&#34;suit&#34;</span>:<span style=color:#3677a9>4</span>}
</code></pre></div><p>We just did a bunch of work to be able to represent our <code>Suit</code> as a string, but the <code>encoding/json</code> package ignores it &ndash; this is because we need to customize how JSON is created from our type. To do so, we must implement the <a href=https://pkg.go.dev/encoding/json#Marshaler><code>json.Marshaler</code></a> interface:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s Suit) <span style=color:#447fcf>MarshalJSON</span>() ([]<span style=color:#6ab825;font-weight:700>byte</span>, <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#6ab825;font-weight:700>return</span> json.<span style=color:#447fcf>Marshal</span>(s.<span style=color:#447fcf>String</span>())
}
</code></pre></div><p>The <code>MarshalJSON</code> function converts the <code>Suit</code> into a string, then JSON-marshals the string so that the output is valid JSON: <code>[]byte("\"♠\"")</code> (quotation marks included). The most important thing to remember is that the method has a <em>value</em> receiver not a <em>pointer</em> receiver &ndash; more on this later. Implementing this method for our <code>Suit</code> object now marshals the following JSON data:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#6ab825;font-weight:700>&#34;value&#34;</span>:<span style=color:#3677a9>7</span>,<span style=color:#6ab825;font-weight:700>&#34;suit&#34;</span>:<span style=color:#ed9d13>&#34;♠&#34;</span>}
</code></pre></div><p>Of course, if we try to Unmarshal this data, we will get an error &ldquo;json: cannot unmarshal string into Go value of type main.Suit&rdquo; because <code>"♠"</code> cannot be converted to a <code>uint8</code> and then to our <code>Suit</code> type. To deal with our custom marshaled JSON data, we&rsquo;ll also have to implement the <a href=https://pkg.go.dev/encoding/json#Unmarshaler><code>json.Unmarshaler</code></a> interface:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s *Suit) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#6ab825;font-weight:700>var</span> suits <span style=color:#6ab825;font-weight:700>string</span>
	<span style=color:#6ab825;font-weight:700>if</span> err := json.<span style=color:#447fcf>Unmarshal</span>(data, &amp;suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> err
	}
	<span style=color:#6ab825;font-weight:700>if</span> *s, err = <span style=color:#447fcf>ParseSuit</span>(suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> err
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>This function is slightly more complicated, so we&rsquo;ll go through it step by step. First, we declare a string variable <code>suits</code> and unmarshal the data into the string &ndash; this is possible because we expect the data to be the JSON string <code>"♠"</code> (quotation marks included). Once we&rsquo;ve unmarshaled this intermediate type, we can then use the <code>ParseSuit</code> function to convert it into a <code>Suit</code> object &ndash; but then what do we do with it? The short answer is that we have to use <a href=https://go.dev/tour/methods/6>pointer indirection</a> to assign the method receiver variable the value returned from <code>ParseSuit</code>. The long answer follows.</p><h2 id=pointers-values-and-reflection-in-json-serialization>Pointers, Values, and Reflection in JSON Serialization</h2><p>The <code>*</code> operator in this context is the <a href=https://en.wikipedia.org/wiki/Dereference_operator>indirection operator (or dereference operator)</a>. It is an operator that works on <code>pointer</code> variables to get access to the value of the variable stored in the memory address (e.g. it is an indirect way to access the value). It is the opposite of the <code>&</code> operator, which is the &ldquo;address-of&rdquo; operator that returns the pointer to the given value. Besides what these operators do, it is also important to understand <a href=https://go.dev/tour/methods/4>method receivers</a> in Golang, which can be either pointer or value receivers depending on the type defined in the method signature.</p><p>The <code>UnmarshalJSON</code> function is a method, meaning it is a function that has an object receiver. Because <code>UnmarshalJSON</code> only returns an error &ndash; it is up to us to unmarshal the data into the receiver (e.g. modify the receiver value as the unmarshaled object). This means we have a choice, we can implement the <code>UnmarshalJSON</code> method with either a value receiver:</p><pre><code>func (s Suit) UnmarshalJSON(data []byte) error
</code></pre><p>or a pointer receiver:</p><pre><code>func (s *Suit) UnmarshalJSON(data []byte) error
</code></pre><p>Although these method signatures are different by one character, the receiver type has a large impact on how the code behaves. If you attempt to use the pointer indirection with a value receiver:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s Suit) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#999;font-style:italic>// ...
</span><span style=color:#999;font-style:italic></span>	<span style=color:#6ab825;font-weight:700>if</span> *s, err = <span style=color:#447fcf>ParseSuit</span>(suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> err
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>The compiler will complain with the following error: &ldquo;invalid operation: cannot indirect s (variable of type Suit)&rdquo;. However, if you don&rsquo;t indirect:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s Suit) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) (err <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#999;font-style:italic>// ...
</span><span style=color:#999;font-style:italic></span>	<span style=color:#6ab825;font-weight:700>if</span> s, err = <span style=color:#447fcf>ParseSuit</span>(suits); err != <span style=color:#6ab825;font-weight:700>nil</span> {
		<span style=color:#6ab825;font-weight:700>return</span> err
	}
	<span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>Then a copy of the value is passed into the <code>UnmarshalJSON</code> method and the original variable is not modified. This means that the <code>Suit</code> on the card you&rsquo;re trying to unmarshal will remain zero-valued:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>card := &amp;Card{}
json.<span style=color:#447fcf>Unmarshal</span>([]<span style=color:#24909d>byte</span>(<span style=color:#ed9d13>`{&#34;value&#34;: 12, &#34;suit&#34;: &#34;♥&#34;}`</span>))
card.Suit == <span style=color:#447fcf>Suit</span>(<span style=color:#3677a9>0</span>)
</code></pre></div><p>The <code>UnmarshalJSON</code> was called successfully but the <code>card.Suit</code> variable was never touched by the value receiver. This means that <strong>the <em>only</em> way to handle <code>UnmarshalJSON</code> is with a pointer receiver and indirection of the unmarshaled value</strong> (or direct modification of the values in the pointer).</p><p>The <a href=https://go.dev/tour/methods/8>rule of thumb</a> for implementing value or pointer receivers is as follows:</p><blockquote><p>In general, all methods on a given type should have either value or pointer receivers, but not a mixture of both.</p></blockquote><p>However, we implemented our <code>MarshalJSON</code> function as a value receiver &mldr; what gives?</p><p>This is where <a href=https://en.wikipedia.org/wiki/Reflective_programming>reflection</a> enters the picture. The <code>encoding/json</code> package makes heavy use of the <a href=https://pkg.go.dev/reflect><code>reflect</code></a> package to examine arbitrary types, determine if those types implement the interfaces we defined in the previous section, get access to struct tags, and more.</p><p>Remember that we defined our <code>Card</code> type as follows:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>type</span> Card <span style=color:#6ab825;font-weight:700>struct</span> {
    Value <span style=color:#6ab825;font-weight:700>uint8</span>
    Suit Suit
}
</code></pre></div><p>The property <code>Suit</code> on the <code>Card</code> is of type <code>Suit</code> &ndash; a value and not a pointer (<code>*Suit</code>). If we implemented our <code>MarshalJSON</code> method with a pointer receiver, you would notice something odd happen:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (s *Suit) <span style=color:#447fcf>MarshalJSON</span>() ([]<span style=color:#6ab825;font-weight:700>byte</span>, <span style=color:#6ab825;font-weight:700>error</span>) {
	<span style=color:#24909d>panic</span>(<span style=color:#ed9d13>&#34;this should not work&#34;</span>)
}
</code></pre></div><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>data, _ := json.<span style=color:#447fcf>Marshal</span>(Spades)
fmt.<span style=color:#447fcf>Println</span>(<span style=color:#24909d>string</span>(data))
</code></pre></div><p>The output is <code>3</code> and the panic is never triggered. In order to trigger the panic you would have to do the following:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>spades := Spades
data, _ := json.<span style=color:#447fcf>Marshal</span>(&amp;spades)
fmt.<span style=color:#447fcf>Println</span>(<span style=color:#24909d>string</span>(data))
</code></pre></div><p>In the first case we&rsquo;re passing a value to the <code>json.Marshal</code> method and in the second case we&rsquo;re passing a pointer. (We have to assign the constant <code>Spades</code> to a variable <code>spades</code> because we cannot use <code>&</code> on a constant &ndash; this allows us to pass the address-of the pointer to the <code>json.Marshal</code> method.)</p><p>In order to use reflection to determine if a variable implements the <code>json.Marshaler</code> interface, it has to determine if the <code>MarshalJSON</code> is in the <a href=http://golang.org/ref/spec#Method_sets>method set</a> of the variable. When using the pointer receiver, it is in the method set of <code>*Suit</code> but not <code>Suit</code> and when using the value receiver, it is in the method set of <code>Suit</code> not <code>*Suit</code>.</p><p>Enums are usually treated as values since they are simple integers, e.g. it is preferable to use <code>Suit</code> rather than <code>*Suit</code> for the same reason it is preferable to use <code>int</code> rather than <code>*int</code>. Although the pointer receiver of <code>MarshalJSON</code> for the enum would work in 98% of cases, the 2% of cases it doesn&rsquo;t work would cause frustrating bugs that would be hard to diagnose, therefore I believe <strong>in the case of enum JSON serialization, mixing pointer and value method receivers is an exception to the normal rule of thumb</strong>.</p><h2 id=sidebar-marshaling-cards>Sidebar: Marshaling Cards</h2><p>To wrap up, I&rsquo;d like to discuss a couple of notes on the <code>Card</code> struct. First why did we add <code>UnmarshalJSON</code> and <code>MarshalJSON</code> to the enum <code>Suit</code> instead of to <code>Card</code>? Here I&rsquo;ll introduce another rule of thumb: <strong>implement the JSON Marshaler and Unmarshaler methods on the smallest possible type that needs custom serialization</strong>. JSON data is usually very nested data with lots of different types and subtypes. To make your custom types more flexible (e.g. using <code>Suit</code> in objects besides <code>Card</code>), you&rsquo;ll want each type to handle it&rsquo;s own marshaling and unmarshaling rather than requiring the parent type to do it.</p><p>Second, if you tried marshaling the <code>Card</code> in the case above where <code>Suit</code> had a pointer receiver to <code>MarshalJSON</code>, you may have noticed that the code worked. I mentioned that in 2% of the cases the pointer receiver would not work, one of those cases is if you add a <code>MarshalJSON</code> method to <code>Card</code> and you attempt to create an intermediate value for the representation:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (c *Card) <span style=color:#447fcf>MarshalJSON</span>() ([]<span style=color:#6ab825;font-weight:700>byte</span>, <span style=color:#6ab825;font-weight:700>error</span>) {
	middle := <span style=color:#24909d>make</span>(<span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>string</span>]<span style=color:#6ab825;font-weight:700>interface</span>{})
	middle[<span style=color:#ed9d13>&#34;value&#34;</span>] = c.Value
	middle[<span style=color:#ed9d13>&#34;suit&#34;</span>] = c.Suit
	<span style=color:#6ab825;font-weight:700>return</span> json.<span style=color:#447fcf>Marshal</span>(middle)
}
</code></pre></div><p>As discussed in the previous section, <code>c.Suit</code> is assigned to the type <code>interface{}</code>, so when the JSON reflection inspects its method set, it cannot find the pointer receiver of <code>MarshalJSON</code>. Without this method, the <code>c.Suit</code> type is <code>Suit</code>, so the JSON reflection can directly assert if the type implements <code>Marshaler</code>.</p><p>Finally - what about custom unmarshaling of a <code>struct</code>, are there any gotchas there? Consider if we want to do custom validation of our card during unmarshal and return an error if the card is not valid (not the best design pattern, but used to illustrate a point):</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (c *Card) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) <span style=color:#6ab825;font-weight:700>error</span> {
    <span style=color:#6ab825;font-weight:700>if</span> err = json.<span style=color:#447fcf>Unmarshal</span>(data, c); err != <span style=color:#6ab825;font-weight:700>nil</span> {
        <span style=color:#6ab825;font-weight:700>return</span> err
    }
    <span style=color:#6ab825;font-weight:700>if</span> c.Value &lt; <span style=color:#3677a9>1</span> || c.Value &gt; <span style=color:#3677a9>13</span> {
        <span style=color:#6ab825;font-weight:700>return</span> errors.<span style=color:#447fcf>New</span>(<span style=color:#ed9d13>&#34;not a valid card value&#34;</span>)
    }
    <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>This code will return a stack overflow because of the infinite recursive call to <code>UnmarshalJSON</code> - e.g. calling <code>json.Unmarshal(data, card)</code> will call <code>c.UnmarshalJSON(data)</code>, which will call <code>json.Unmarshal(data, c)</code> which will call <code>c.UnmarshalJSON(data)</code> and so on until the maximum recursion depth is reached and a stack overflow occurs. To solve this problem, an <a href=https://talks.golang.org/2012/10things.slide#2><em>anonymous struct</em></a> is required:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>func</span> (c *Card) <span style=color:#447fcf>UnmarshalJSON</span>(data []<span style=color:#6ab825;font-weight:700>byte</span>) <span style=color:#6ab825;font-weight:700>error</span> {
    cs := <span style=color:#6ab825;font-weight:700>struct</span>{
        Value <span style=color:#6ab825;font-weight:700>uint8</span> <span style=color:#ed9d13>`json:&#34;value&#34;`</span>
        Suit  Suit  <span style=color:#ed9d13>`json:&#34;suit&#34;`</span>
    }{}

    <span style=color:#6ab825;font-weight:700>if</span> err = json.<span style=color:#447fcf>Unmarshal</span>(data, &amp;cs); err != <span style=color:#6ab825;font-weight:700>nil</span> {
        <span style=color:#6ab825;font-weight:700>return</span> err
    }

    <span style=color:#6ab825;font-weight:700>if</span> cs.Value &lt; <span style=color:#3677a9>1</span> || cs.Value &gt; <span style=color:#3677a9>13</span> {
        <span style=color:#6ab825;font-weight:700>return</span> errors.<span style=color:#447fcf>New</span>(<span style=color:#ed9d13>&#34;not a valid card value&#34;</span>)
    }

    c.Value = cs.Value
    c.Suit = cs.Suit
    <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>
}
</code></pre></div><p>Duplicating struct definitions will often make maintenance harder, but this is sometimes necessary, particularly in the case of generated code that does not allow you to implement your own <code>json</code> struct tags (e.g. protocol buffers).</p><h2 id=conclusion>Conclusion</h2><p>When you define your own types in Go and you want control over how those types are serialized and deserialized into JSON - the <code>Marshaler</code> and <code>Unmarshaler</code> interfaces give you a lot of flexibility. However, knowing and understanding pointers, values, indirection, and receivers is essential to correctly implementing these interfaces &ndash; and common wisdom can sometimes lead to tripping hazards. In particular, when dealing with enumerations or other primitive type aliases, the rule of thumb to use all pointer or all value receivers does not hold, and instead mixed receiver types are your best bet.</p></div><div class="social-share pt-4"><h4>Share:</h4><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Marshaling%20Go%20Enums%20to%20and%20from%20JSON&url=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://plus.google.com/share?url=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--google resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.37 12.93c-.73-.52-1.4-1.27-1.4-1.5.0-.43.03-.63.98-1.37 1.23-.97 1.9-2.23 1.9-3.57.0-1.22-.36-2.3-1-3.05h.5c.1.0.2-.04.28-.1l1.36-.98c.16-.12.23-.34.17-.54-.07-.2-.25-.33-.46-.33H7.6c-.66.0-1.34.12-2 .35-2.23.76-3.78 2.66-3.78 4.6.0 2.76 2.13 4.85 5 4.9-.07.23-.1.45-.1.66.0.43.1.83.33 1.22h-.08c-2.72.0-5.17 1.34-6.1 3.32-.25.52-.37 1.04-.37 1.56.0.5.13.98.38 1.44.6 1.04 1.84 1.86 3.55 2.28.87.23 1.82.34 2.8.34.88.0 1.7-.1 2.5-.34 2.4-.7 3.97-2.48 3.97-4.54.0-1.97-.63-3.15-2.33-4.35zm-7.7 4.5c0-1.42 1.8-2.68 3.9-2.68h.05c.45.0.9.07 1.3.2l.42.28c.96.66 1.6 1.1 1.77 1.8.05.16.07.33.07.5.0 1.8-1.33 2.7-3.96 2.7-1.98.0-3.54-1.23-3.54-2.8zM5.54 3.9c.33-.38.75-.58 1.23-.58h.05c1.35.05 2.64 1.55 2.88 3.35.14 1.02-.08 1.97-.6 2.55-.32.37-.74.56-1.23.56h-.03c-1.32-.04-2.63-1.6-2.87-3.4-.13-1 .08-1.92.58-2.5zM23.5 9.5h-3v-3h-2v3h-3v2h3v3h2v-3h3"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Marshaling%20Go%20Enums%20to%20and%20from%20JSON&body=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_self rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f&resubmit=true&title=Marshaling%20Go%20Enums%20to%20and%20from%20JSON" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Marshaling%20Go%20Enums%20to%20and%20from%20JSON%20https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=Marshaling%20Go%20Enums%20to%20and%20from%20JSON&url=https%3a%2f%2frotational.io%2fblog%2fmarshaling-go-enums-to-and-from-json%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64.0 9.508.0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102.0 001.75.527l2.96-2.41a.405.405.0 01.494-.013l5.34 3.87a1.1 1.1.0 001.046.135 1.1 1.1.0 00.682-.803l3.91-18.795A1.102 1.102.0 0022.5.075L.706 8.475z"/></svg></div></div></a></div><div class=mt-5></div></div></div></div></section></div><footer id=footer class=section-bg><div class=container><div class="row wow fadeInUp" data-wow-duration=500ms><div class=col-xl-12><div class=social-icon><ul class=list-inline><li class=list-inline-item><a href=https://twitter.com/rotationalio target=_blank><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://github.com/rotationalio target=_blank><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/rotational/ target=_blank><i class=ti-linkedin></i></a></li></ul></div><div class="copyright text-center"><a href=https://rotational.io/><img src=https://rotational.io/images/assets/logos/logo.png alt="Rotational Labs" height=92></a><br><p>Copyright © 2021 Rotational Labs, LLC, All Rights Reserved</p></div></div></div></div></footer><script src=https://rotational.io/plugins/jquery/jquery.min.js></script><script src=https://rotational.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://rotational.io/plugins/slick/slick.min.js></script><script src=https://rotational.io/plugins/shuffle/shuffle.min.js></script><script src=https://rotational.io/plugins/magnific-popup/jquery.magnific-popup.min.js></script><script src=https://rotational.io/plugins/lazy-load/lozad.min.js></script><script src=https://rotational.io/plugins/google-map/map.js></script><script src=https://rotational.io/js/script.min.5db5ae6f88052715e823d7c52f3fa7a832565352b0f76c1d2cee2a3b564a0716fa9d51878a9965389c3d856f2d7c6330.js integrity=sha384-XbWub4gFJxXoI9fFLz+nqDJWU1Kw92wdLO4qO1ZKBxb6nVGHipllOJw9hW8tfGMw></script></body></html>